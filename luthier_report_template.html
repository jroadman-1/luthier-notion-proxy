<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Work Order - Luthier Services</title>
  <style>
    @page { size: letter; margin: 0.4in; }
    * { box-sizing: border-box; }
    body {
      font-family: 'Times New Roman', serif;
      margin: 0; padding: 0; color: #333; line-height: 1.3; font-size: 12px;
    }
    .report-container { 
      max-width: 8.5in; 
      margin: 0 auto; 
      background: white; 
      padding: 10px;
    }

    /* Compact Letterhead */
    .letterhead {
      border-bottom: 2px solid #2c3e50; 
      margin-bottom: 12px; 
      padding-bottom: 8px;
      display: flex; 
      align-items: center; 
      justify-content: space-between;
    }
    .logo-section {
      flex: 0 0 80px; 
      height: 60px; 
      background: #f8f9fa; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 9px; 
      color: #666;
    }
    .company-info { flex: 1; text-align: center; margin: 0 15px; }
    .company-name { font-size: 20px; font-weight: bold; color: #2c3e50; margin-bottom: 3px; }
    .company-tagline { font-size: 12px; color: #666; font-style: italic; margin-bottom: 4px; }
    .contact-info { font-size: 10px; color: #555; }
    .report-date { flex: 0 0 100px; text-align: right; font-size: 10px; color: #444; line-height: 1.4; }

    /* Compact Project Header */
    .project-header { 
      background: #f8f9fa; 
      padding: 8px 12px; 
      border: 1px solid #dee2e6; 
      border-radius: 3px; 
      margin-bottom: 12px; 
    }
    .project-title { font-size: 16px; font-weight: bold; color: #2c3e50; margin-bottom: 6px; text-align: center; }
    .project-basic-info { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .info-item { display: flex; flex-direction: column; }
    .info-label { font-weight: bold; font-size: 9px; color: #666; text-transform: uppercase; margin-bottom: 2px; }
    .info-value { font-size: 11px; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 1px; min-height: 14px; }

    /* Two Column Layout - Tighter */
    .main-content { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 20px; 
      margin-bottom: 12px; 
    }

    /* Section Styling - Compact */
    .section { margin-bottom: 12px; break-inside: avoid; }
    .section.full-width { grid-column: 1 / -1; }
    .section-title { 
      font-size: 12px; 
      font-weight: bold; 
      color: #2c3e50; 
      border-bottom: 1.5px solid #2c3e50; 
      padding-bottom: 2px; 
      margin-bottom: 6px; 
      text-transform: uppercase;
    }

    /* Measurements Table - Compact */
    .measurements-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 8px; }
    .measurements-table th { 
      background: #f8f9fa; 
      padding: 3px 2px; 
      text-align: left; 
      border: 1px solid #dee2e6; 
      font-weight: bold; 
      font-size: 9px; 
    }
    .measurements-table td { padding: 3px 2px; border: 1px solid #dee2e6; text-align: center; font-size: 10px; }
    .measurements-table .measurement-name { text-align: left; font-weight: 500; }

    /* Specs Grid - More Compact */
    .specs-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 4px 8px; 
      font-size: 10px; 
      margin-bottom: 8px;
    }
    .spec-item { display: flex; gap: 4px; }
    .spec-label { font-weight: bold; color: #666; min-width: 60px; }
    .spec-value { color: #333; }

    /* Actions Checklist - Compact */
    .actions-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 3px; 
      font-size: 10px; 
    }
    .action-item { display: flex; align-items: center; gap: 5px; padding: 1px 0; }
    .checkbox { 
      width: 10px; 
      height: 10px; 
      border: 1px solid #666; 
      display: inline-block; 
      position: relative; 
      flex-shrink: 0;
    }
    .checkbox.checked::after { 
      content: '‚úì'; 
      position: absolute; 
      left: 1px; 
      top: -2px; 
      font-size: 8px; 
      font-weight: bold; 
    }

    /* Notes Section - Compact */
    .notes-box {
      border: 1px solid #dee2e6;
      min-height: 50px;
      max-height: 80px;
      padding: 6px;
      background: #fafafa;
      font-size: 10px;
      line-height: 1.4;
      white-space: pre-wrap;
      overflow: hidden;
    }

    /* Billing Section - Prominent but Compact */
    .billing-section { 
      background: #f8f9fa; 
      border: 2px solid #2c3e50; 
      border-radius: 3px; 
      padding: 10px 12px; 
      margin-top: 12px;
    }
    .billing-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #dee2e6;
    }
    .billing-title { 
      font-size: 13px; 
      font-weight: bold; 
      color: #2c3e50; 
      text-transform: uppercase;
    }
    .billing-breakdown {
      margin-bottom: 8px;
    }
    .billing-item {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      font-size: 10px;
      color: #555;
    }
    .billing-item-name {
      flex: 1;
    }
    .billing-item-amount {
      font-weight: 500;
      color: #333;
      min-width: 80px;
      text-align: right;
    }
    .billing-subtotal {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      margin-top: 5px;
      border-top: 1px solid #dee2e6;
      font-size: 11px;
      font-weight: 600;
      color: #2c3e50;
    }
    .billing-discount {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      font-size: 10px;
      color: #d9534f;
      font-weight: 500;
    }
    .billing-tax {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      font-size: 10px;
      color: #2c7a2c;
      font-weight: 500;
    }
    .billing-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0 0 0;
      margin-top: 6px;
      border-top: 2px solid #2c3e50;
    }
    .billing-label { 
      font-size: 13px; 
      font-weight: bold; 
      color: #2c3e50; 
      text-transform: uppercase;
    }
    .billing-amount { 
      font-size: 18px; 
      font-weight: bold; 
      color: #2c3e50; 
    }

    /* Signature Section - Hidden */
    .signature-section { 
      display: none;
    }

    /* Print Button */
    .print-button { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      background: #007bff; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 12px;
      z-index: 1000;
    }
    .print-button:hover { background: #0056b3; }
    
    @media print { 
      .print-button { display: none; } 
      .report-container { padding: 0; }
      .section { break-inside: avoid; }
      body { font-size: 10px; }
    }
  </style>
</head>
<body>
  <button class="print-button" onclick="window.print()">üñ®Ô∏è Print Report</button>

  <div class="report-container">
    <!-- Letterhead -->
    <header class="letterhead">
      <div class="logo-section">
        LOGO<br>AREA
      </div>
      <div class="company-info">
        <div class="company-name">ROADMAN GUITARS</div>
        <div class="company-tagline">Expert Luthier Services</div>
        <div class="contact-info">
          123 Music Lane | Austin, TX 78701 | (512) 555-ROCK | <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c2abaca4ad82b0ada3a6afa3aca5b7abb6a3b0b1eca1adaf">[email&#160;protected]</a>
        </div>
      </div>
      <div class="report-date">
        <strong>SERVICE DATE</strong><br>
        <span id="svcDate"></span><br>
        <strong>PROJECT</strong><br>
        <span id="projId"></span>
      </div>
    </header>

    <!-- Project Header -->
    <div class="project-header">
      <div class="project-title">WORK ORDER</div>
      <div class="project-basic-info">
        <div class="info-item">
          <div class="info-label">Customer</div>
          <div class="info-value" id="customerName"></div>
        </div>
        <div class="info-item">
          <div class="info-label">Instrument</div>
          <div class="info-value" id="instrumentName"></div>
        </div>
        <div class="info-item">
          <div class="info-label">Serial Number</div>
          <div class="info-value" id="serialNumberText"></div>
        </div>
        <div class="info-item">
          <div class="info-label">Status</div>
          <div class="info-value" id="statusText"></div>
        </div>
      </div>
    </div>

    <!-- Two Column Content -->
    <div class="main-content">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Measurements -->
        <div class="section">
          <div class="section-title">Measurements</div>
          <table class="measurements-table">
            <thead>
              <tr>
                <th style="width: 50%">Measurement</th>
                <th style="width: 25%">Before</th>
                <th style="width: 25%">After</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="measurement-name">Neck Relief</td>
                <td id="m_relief_before"></td>
                <td id="m_relief_after"></td>
              </tr>
              <tr>
                <td class="measurement-name">1st String @ 1st Fret</td>
                <td id="m_1s_1f_before"></td>
                <td id="m_1s_1f_after"></td>
              </tr>
              <tr>
                <td class="measurement-name">1st String @ 12th Fret</td>
                <td id="m_1s_12f_before"></td>
                <td id="m_1s_12f_after"></td>
              </tr>
              <tr>
                <td class="measurement-name">6th String @ 1st Fret</td>
                <td id="m_6s_1f_before"></td>
                <td id="m_6s_1f_after"></td>
              </tr>
              <tr>
                <td class="measurement-name">6th String @ 12th Fret</td>
                <td id="m_6s_12f_before"></td>
                <td id="m_6s_12f_after"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Specifications -->
        <div class="section">
          <div class="section-title">Specifications</div>
          <div class="specs-grid">
            <div class="spec-item">
              <span class="spec-label">Type:</span>
              <span class="spec-value" id="spec_type"></span>
            </div>
            <div class="spec-item">
              <span class="spec-label">Finish:</span>
              <span class="spec-value" id="spec_finish"></span>
            </div>
            <div class="spec-item">
              <span class="spec-label">Strings:</span>
              <span class="spec-value" id="spec_strings"></span>
            </div>
            <div class="spec-item">
              <span class="spec-label">Tuning:</span>
              <span class="spec-value" id="spec_tuning"></span>
            </div>
            <div class="spec-item">
              <span class="spec-label">Radius:</span>
              <span class="spec-value" id="spec_radius"></span>
            </div>
            <div class="spec-item">
              <span class="spec-label">Fretwire:</span>
              <span class="spec-value" id="spec_fretwire"></span>
            </div>
            <div class="spec-item">
              <span class="spec-label">Tremolo:</span>
              <span class="spec-value" id="spec_tremolo"></span>
            </div>
            <div class="spec-item">
              <span class="spec-label">Due Date:</span>
              <span class="spec-value" id="spec_due"></span>
            </div>
          </div>
        </div>

        <!-- Customer Request -->
        <div class="section">
          <div class="section-title">Customer Request</div>
          <div class="notes-box" id="customerNotesBox"></div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">
        <!-- Standard Actions -->
        <div class="section">
          <div class="section-title">Standard Actions</div>
          <div class="actions-grid">
            <div class="action-item"><span class="checkbox" id="act_heightRadius"></span> Height/Radius</div>
            <div class="action-item"><span class="checkbox" id="act_intonation"></span> Intonation</div>
            <div class="action-item"><span class="checkbox" id="act_pickupHeight"></span> Pickup Height</div>
            <div class="action-item"><span class="checkbox" id="act_trussRod"></span> Truss Rod</div>
            <div class="action-item"><span class="checkbox" id="act_stringSlots"></span> String Slots</div>
            <div class="action-item"><span class="checkbox" id="act_cleanPolish"></span> Clean/Polish</div>
            <div class="action-item"><span class="checkbox" id="act_strings"></span> New Strings</div>
            <div class="action-item"><span class="checkbox" id="act_lubeSlots"></span> Lube Slots</div>
            <div class="action-item"><span class="checkbox" id="act_oilBoard"></span> Oil Fretboard</div>
            <div class="action-item"><span class="checkbox" id="act_polishFrets"></span> Polish Frets</div>
            <div class="action-item"><span class="checkbox" id="act_testElectronics"></span> Test Electronics</div>
            <div class="action-item"><span class="checkbox" id="act_tightenHardware"></span> Tighten Hardware</div>
            <div class="action-item"><span class="checkbox" id="act_tremoloTension"></span> Tremolo Tension</div>
            <div class="action-item"><span class="checkbox" id="act_neckAngle"></span> Neck Angle</div>
          </div>
        </div>

        <!-- Additional Work -->
        <div class="section full-width">
          <div class="section-title">Additional Work</div>
          <div class="notes-box" id="additionalWorkBox"></div>
        </div>

        <!-- Notes -->
        <div class="section full-width">
          <div class="section-title">Notes</div>
          <div class="notes-box" id="techNotesBox"></div>
        </div>
      </div>
    </div>

    <!-- Billing Section -->
    <div class="billing-section">
      <div class="billing-header">
        <span class="billing-title">Billing Breakdown</span>
      </div>
      <div class="billing-breakdown" id="billingBreakdown">
        <!-- Workflow and milestone items will be inserted here -->
      </div>
      <div class="billing-total">
        <span class="billing-label">Total Amount</span>
        <span class="billing-amount" id="billingTotal">$0.00</span>
      </div>
    </div>

    <!-- Signature Section -->
    <div class="signature-section">
      <div class="signature-box">
        <div class="signature-line"></div>
        <div class="signature-label">Customer Signature / Date</div>
      </div>
      <div class="signature-box">
        <div class="signature-line"></div>
        <div class="signature-label">Technician Signature / Date</div>
      </div>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
  (function(){
    // Pull payload saved by the management page
    const raw = localStorage.getItem('luthierReportData');
    const data = raw ? JSON.parse(raw) : {};
    const p = (data && data.project) ? data.project : {};
    const ms = Array.isArray(data.milestones) ? data.milestones : [];

    // Helpers
    const setText = (id, v) => {
      const el = document.getElementById(id);
      if (!el) return;
      const s = (v ?? '');
      el.textContent = typeof s === 'string' ? s.trim() : s;
    };

    const setCheck = (id, on) => { 
      const el = document.getElementById(id); 
      if (el) el.classList.toggle('checked', !!on); 
    };
    
    const inch = (x) => (x === '' || x == null || isNaN(parseFloat(x))) ? '' : (parseFloat(x).toFixed(3) + '"');

    // Letterhead
    const svcDate = (new Date()).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    setText('svcDate', svcDate);
    setText('projId', p.projectId ? ('#' + p.projectId) : (p.id ? ('#' + String(p.id).slice(0,8)) : ''));

    // Header info
    const instrumentName = [p.instrumentMake, p.instrumentModel].filter(Boolean).join(' ');
    setText('customerName', p.name || '');
    setText('instrumentName', instrumentName || p.instrumentType || '');
    setText('statusText', p.status || '');
    setText('serialNumberText', p.serialNumber || '');

    // Measurements
    setText('m_relief_before', inch(p.neckReliefBefore));
    setText('m_relief_after', inch(p.neckReliefAfter));
    setText('m_1s_1f_before', inch(p.before1stString1stFret));
    setText('m_1s_1f_after', inch(p.after1stString1stFret));
    setText('m_1s_12f_before', inch(p.before1stString12thFret));
    setText('m_1s_12f_after', inch(p.after1stString12thFret));
    setText('m_6s_1f_before', inch(p.before6thString1stFret));
    setText('m_6s_1f_after', inch(p.after6thString1stFret));
    setText('m_6s_12f_before', inch(p.before6thString12thFret));
    setText('m_6s_12f_after', inch(p.after6thString12thFret));

    // Specs
    setText('spec_type', p.instrumentType || '');
    setText('spec_finish', p.instrumentFinish || '');
    setText('spec_strings', [p.stringBrand, p.stringGauge].filter(Boolean).join(' ') || '');
    setText('spec_tuning', p.tuning || '');
    setText('spec_radius', (p.fretboardRadius != null && p.fretboardRadius !== '') ? (p.fretboardRadius + '"') : '');
    setText('spec_fretwire', p.fretwire || '');
    setText('spec_tremolo', p.tremolo || 'N/A');
    if (p.dueDate) {
      const d = new Date(p.dueDate);
      setText('spec_due', isNaN(d) ? p.dueDate : d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }));
    } else {
      setText('spec_due', '');
    }

    // Notes
    setText('customerNotesBox', p.intakeNotes || '');
    setText('additionalWorkBox', p.additionalActions || '');
    setText('techNotesBox', p.notes || '');

    // Actions
    const a = p.actions || {};
    setCheck('act_heightRadius', !!a.adjustedHeightRadius);
    setCheck('act_intonation', !!a.adjustedIntonation);
    setCheck('act_pickupHeight', !!a.adjustedPickupHeight);
    setCheck('act_trussRod', !!a.adjustedTrussRod);
    setCheck('act_stringSlots', !!a.adjustedStringSlots);
    setCheck('act_cleanPolish', !!a.cleanedPolished);
    setCheck('act_strings', !!a.installedStretchedStrings);
    setCheck('act_lubeSlots', !!a.lubricatedStringSlots);
    setCheck('act_oilBoard', !!a.oiledFretboard);
    setCheck('act_polishFrets', !!a.polishedFrets);
    setCheck('act_testElectronics', !!a.testedElectronics);
    setCheck('act_tightenHardware', !!a.tightenedHardware);
    setCheck('act_tremoloTension', !!a.adjustedTremoloTension);
    setCheck('act_neckAngle', !!a.adjustedNeckAngle);

    // ====== BILLING - AUTO-POPULATE FROM ESTIMATE WITH BREAKDOWN ======
    // Pull hourly rate from project data (stored in Notion), default to 100
    const HOURLY_RATE = (p.hourlyRate != null && p.hourlyRate !== '') ? parseFloat(p.hourlyRate) : 100;
    let subtotal = 0;
    const billingBreakdownEl = document.getElementById('billingBreakdown');
    
    // Filter only billable milestones (matching estimate logic)
    const billableMilestones = ms.filter(m => m && m.name && m.includeInEstimate !== false);
    
    // Group milestones by workflow
    const workflowGroups = {};
    const standaloneMilestones = [];
    
    billableMilestones.forEach(milestone => {
      if (milestone.workflowGroupId) {
        if (!workflowGroups[milestone.workflowGroupId]) {
          workflowGroups[milestone.workflowGroupId] = {
            name: milestone.workflowName || 'Workflow',
            totalHours: 0,
            order: milestone.order || 999
          };
        }
        workflowGroups[milestone.workflowGroupId].totalHours += parseFloat(milestone.estimatedHours) || 0;
        workflowGroups[milestone.workflowGroupId].order = Math.min(
          workflowGroups[milestone.workflowGroupId].order, 
          milestone.order || 999
        );
      } else {
        standaloneMilestones.push(milestone);
      }
    });
    
    // Combine and sort items
    const allItems = [
      ...Object.keys(workflowGroups).map(groupId => ({
        type: 'workflow',
        data: workflowGroups[groupId],
        order: workflowGroups[groupId].order
      })),
      ...standaloneMilestones.map(m => ({
        type: 'milestone',
        data: m,
        order: m.order || 999
      }))
    ].sort((a, b) => a.order - b.order);
    
    // Render workflow and milestone items
    allItems.forEach(item => {
      if (item.type === 'workflow') {
        const cost = item.data.totalHours * HOURLY_RATE;
        subtotal += cost;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'billing-item';
        itemDiv.innerHTML = `
          <span class="billing-item-name">${item.data.name}</span>
          <span class="billing-item-amount">$${cost.toFixed(2)}</span>
        `;
        billingBreakdownEl.appendChild(itemDiv);
      } else {
        const estimatedHours = parseFloat(item.data.estimatedHours) || 0;
        const cost = estimatedHours * HOURLY_RATE;
        subtotal += cost;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'billing-item';
        itemDiv.innerHTML = `
          <span class="billing-item-name">${item.data.name}</span>
          <span class="billing-item-amount">$${cost.toFixed(2)}</span>
        `;
        billingBreakdownEl.appendChild(itemDiv);
      }
    });
    
    // Add parts
    const parts = Array.isArray(data.parts) ? data.parts : [];
    parts.forEach(part => {
      const quantity = parseFloat(part.quantity) || 0;
      const pricePerItem = parseFloat(part.pricePerItem) || 0;
      const partTotal = quantity * pricePerItem;
      subtotal += partTotal;
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'billing-item';
      const partName = part.name + (quantity > 1 ? ' (x' + quantity + ')' : '');
      itemDiv.innerHTML = `
        <span class="billing-item-name">${partName}</span>
        <span class="billing-item-amount">$${partTotal.toFixed(2)}</span>
      `;
      billingBreakdownEl.appendChild(itemDiv);
    });
    
    // Show subtotal if there are items
    if (allItems.length > 0 || parts.length > 0) {
      const subtotalDiv = document.createElement('div');
      subtotalDiv.className = 'billing-subtotal';
      subtotalDiv.innerHTML = `
        <span>Subtotal</span>
        <span>$${subtotal.toFixed(2)}</span>
      `;
      billingBreakdownEl.appendChild(subtotalDiv);
    }
    
    // Apply discount
    const discountPercent = (p.discount != null && p.discount !== '') ? parseFloat(p.discount) : 0;
    let billingTotal = subtotal;
    
    if (discountPercent > 0) {
      const discountAmount = (subtotal * discountPercent) / 100;
      billingTotal = subtotal - discountAmount;
      
      const discountDiv = document.createElement('div');
      discountDiv.className = 'billing-discount';
      discountDiv.innerHTML = `
        <span>Discount (${discountPercent}%)</span>
        <span>-$${discountAmount.toFixed(2)}</span>
      `;
      billingBreakdownEl.appendChild(discountDiv);
    }
    
    // Display tax if it exists (already calculated in project management)
    const taxAmount = (p.taxAmount != null && p.taxAmount !== '') ? parseFloat(p.taxAmount) : 0;
    if (taxAmount > 0) {
      billingTotal += taxAmount;
      
      // Calculate tax rate for display purposes
      const afterDiscount = subtotal - ((subtotal * discountPercent) / 100);
      const taxRate = afterDiscount > 0 ? (taxAmount / afterDiscount) * 100 : 0;
      
      const taxDiv = document.createElement('div');
      taxDiv.className = 'billing-tax';
      taxDiv.innerHTML = `
        <span>Tax (${taxRate.toFixed(3)}%)</span>
        <span>$${taxAmount.toFixed(2)}</span>
      `;
      billingBreakdownEl.appendChild(taxDiv);
    }
    
    // Use stored total as fallback
    if ((!billingTotal || isNaN(billingTotal)) && p.total != null) {
      billingTotal = par
