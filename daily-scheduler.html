<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Luthier Scheduler</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .debug { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .milestone { background: #f8f9fa; border-left: 4px solid #3498db; padding: 10px; margin: 5px 0; }
        .error { background: #ffebee; border-left: 4px solid #f44336; padding: 10px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Debug Luthier Scheduler</h1>
    
    <div class="debug">
        <h3>Debug Info</h3>
        <div id="debugInfo">Loading...</div>
    </div>
    
    <button class="btn" onclick="testData()">Test Data</button>
    <button class="btn" onclick="testSchedule()">Test Schedule</button>
    <button class="btn" onclick="testAPI()">Test API</button>
    
    <div id="output"></div>

    <script>
        // Sample data
        const projects = [
            { id: 1, name: "John Smith", instrumentMake: "Martin", instrumentModel: "D-28", complexity: 4, profitability: 5, status: "In Progress", dueDate: "2025-09-15", lastWorked: "2025-09-10" },
            { id: 2, name: "Sarah Johnson", instrumentMake: "Gibson", instrumentModel: "Les Paul", complexity: 2, profitability: 3, status: "In Progress", dueDate: "2025-09-20", lastWorked: "2025-09-11" }
        ];

        const milestones = [
            { id: 1, projectId: 1, name: "Remove strings and hardware", estimatedHours: 0.5, order: 1, status: "Completed" },
            { id: 2, projectId: 1, name: "Level fretboard", estimatedHours: 1.0, order: 2, status: "Ready" },
            { id: 3, projectId: 2, name: "Adjust truss rod", estimatedHours: 0.5, order: 1, status: "Ready" }
        ];

        function log(message) {
            console.log(message);
            const output = document.getElementById('output');
            output.innerHTML += `<div class="debug">${message}</div>`;
        }

        function error(message) {
            console.error(message);
            const output = document.getElementById('output');
            output.innerHTML += `<div class="error">ERROR: ${message}</div>`;
        }

        function testData() {
            log(`Projects loaded: ${projects.length}`);
            log(`Milestones loaded: ${milestones.length}`);
            
            projects.forEach(p => {
                log(`Project: ${p.name} - ${p.instrumentMake} ${p.instrumentModel} (Complexity: ${p.complexity})`);
            });
            
            milestones.forEach(m => {
                log(`Milestone: ${m.name} (${m.estimatedHours}h, Status: ${m.status})`);
            });
        }

        function testSchedule() {
            try {
                log("Testing schedule generation...");
                
                // Get ready milestones
                const readyMilestones = [];
                projects.forEach(project => {
                    const projectMilestones = milestones
                        .filter(m => m.projectId === project.id)
                        .sort((a, b) => a.order - b.order);
                    
                    for (let milestone of projectMilestones) {
                        if (milestone.status === 'Ready') {
                            readyMilestones.push({ milestone, project });
                            break;
                        }
                    }
                });
                
                log(`Found ${readyMilestones.length} ready milestones`);
                
                readyMilestones.forEach(item => {
                    log(`Ready: ${item.milestone.name} (${item.project.name})`);
                });

                // Create simple schedule
                let html = '<h3>Simple Schedule:</h3>';
                readyMilestones.forEach(item => {
                    html += `
                        <div class="milestone">
                            <strong>${item.milestone.name}</strong> (${item.milestone.estimatedHours}h)<br>
                            Project: ${item.project.name} - ${item.project.instrumentMake} ${item.project.instrumentModel}
                        </div>
                    `;
                });
                
                document.getElementById('output').innerHTML += html;
                
            } catch (e) {
                error(`Schedule generation failed: ${e.message}`);
            }
        }

        async function testAPI() {
            try {
                log("Testing API connection...");
                const response = await fetch('/api/notion-proxy');
                log(`API Response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`API returned: ${JSON.stringify(data).substring(0, 200)}...`);
                } else {
                    const text = await response.text();
                    error(`API error: ${text}`);
                }
            } catch (e) {
                error(`API connection failed: ${e.message}`);
            }
        }

        // Initialize
        window.onload = function() {
            document.getElementById('debugInfo').innerHTML = `
                <strong>Browser:</strong> ${navigator.userAgent}<br>
                <strong>URL:</strong> ${window.location.href}<br>
                <strong>JavaScript:</strong> Working âœ“<br>
                <strong>Data loaded:</strong> ${projects.length} projects, ${milestones.length} milestones
            `;
            
            log("Debug scheduler loaded successfully");
        };
    </script>
</body>
</html>
