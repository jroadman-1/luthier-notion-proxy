<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luthier Daily Scheduler</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --card: #ffffff;
      --ink: #2c3e50;
      --muted: #666;
      --line: rgba(0,0,0,0.08);
      --blue: #3498db;
      --blue-700: #2980b9;
      --green: #27ae60;
      --green-700: #1f8a4d;
      --amber: #f39c12;
      --red: #e74c3c;
      --violet: #8e44ad;
      --gray-100: #f8f9fa;
      --gray-200: #ecf0f1;
      --gray-300: #e9ecef;
    }
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: 20px; 
      background: var(--bg); 
      color: var(--ink); 
    }
    .header { 
      background: var(--ink); 
      color: #fff; 
      padding: 20px; 
      border-radius: 8px; 
      text-align: center; 
      margin-bottom: 20px; 
    }
    .controls, .schedule-container { 
      background: var(--card); 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px var(--line); 
    }
    .controls { 
      margin-bottom: 20px; 
    }
    
    /* Dropdown styles */
    .controls-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .dropdown-toggle {
      background: none;
      border: none;
      color: var(--blue);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .dropdown-toggle:hover {
      background: var(--gray-100);
    }
    
    .dropdown-arrow {
      transition: transform 0.3s ease;
      font-size: 12px;
    }
    
    .dropdown-arrow.expanded {
      transform: rotate(180deg);
    }
    
    .adjustments-dropdown {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    
    .adjustments-dropdown.expanded {
      max-height: 500px;
      opacity: 1;
      margin-bottom: 20px;
    }
    
    .input-group { 
      margin-bottom: 12px; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }
    .input-group label { 
      width: 230px; 
      font-weight: bold; 
    }
    .input-group input[type="number"] { 
      padding: 8px; 
      border: 1px solid #ddd; 
      border-radius: 6px; 
      width: 120px; 
    }
    .priority-weights { 
      background: var(--gray-100); 
      padding: 15px; 
      border-radius: 6px; 
      margin: 15px 0; 
    }
    .slider-group { 
      margin-bottom: 12px; 
    }
    .slider-group label { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 6px; 
      font-size: 14px; 
    }
    .slider-group input[type="range"] { 
      width: 100%; 
    }
    .weight-total { 
      font-weight: bold; 
      text-align: center; 
      margin-top: 10px; 
      padding: 8px; 
      background: var(--gray-300); 
      border-radius: 4px; 
    }
    .btn { 
      background: var(--blue); 
      color: #fff; 
      border: 0; 
      padding: 10px 16px; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 14px; 
      margin-right: 8px; 
    }
    .btn:hover { 
      background: var(--blue-700); 
    }
    .btn.secondary { 
      background: #95a5a6; 
    }
    .btn.success { 
      background: var(--green); 
    }
    .btn.success:hover { 
      background: var(--green-700); 
    }

    .milestone-item { 
      background: var(--gray-100); 
      border-left: 4px solid var(--blue); 
      padding: 14px; 
      margin-bottom: 10px; 
      border-radius: 6px; 
    }
    .milestone-item.complex { 
      border-left-color: var(--red); 
      background: #fdf2f2; 
    }
    .milestone-item.completed { 
      opacity: 0.6; 
      background: #d4edda; 
      border-left-color: #28a745; 
    }
    .loading { 
      text-align: center; 
      padding: 20px; 
      color: var(--muted); 
    }
    .error { 
      background: #f8d7da; 
      color: #721c24; 
      padding: 15px; 
      border-radius: 6px; 
      margin: 10px 0; 
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé∏ Luthier Daily Scheduler</h1>
    <p>Smart scheduling with complexity balance, quick wins, and due-date buffers</p>
  </div>

  <div class="controls">
    <div class="controls-header">
      <h3>‚öôÔ∏è Scheduling Controls</h3>
      <button class="dropdown-toggle" id="adjustments-toggle">
        <span>Show Adjustments</span>
        <span class="dropdown-arrow" id="dropdown-arrow">‚ñº</span>
      </button>
    </div>

    <div class="input-group">
      <label>Available Hours Today:</label>
      <input type="number" id="availableHours" value="8" min="1" max="16" step="0.5">
    </div>

    <div class="adjustments-dropdown" id="adjustments-dropdown">
      <div class="priority-weights">
        <h4>Priority Weight Adjustments</h4>

        <div class="slider-group">
          <label>
            <span>Due Date Urgency</span>
            <span><span id="dueDateWeight">40</span>%</span>
          </label>
          <input type="range" id="dueDateSlider" min="0" max="80" value="40">
        </div>

        <div class="slider-group">
          <label>
            <span>Complexity Priority</span>
            <span><span id="complexityWeight">30</span>%</span>
          </label>
          <input type="range" id="complexitySlider" min="0" max="80" value="30">
        </div>

        <div class="slider-group">
          <label>
            <span>Days Since Worked</span>
            <span><span id="daysWorkedWeight">10</span>%</span>
          </label>
          <input type="range" id="daysWorkedSlider" min="0" max="50" value="10">
        </div>

        <div class="slider-group">
          <label>
            <span>Quick Wins Boost</span>
            <span><span id="quickWeight">20</span>%</span>
          </label>
          <input type="range" id="quickSlider" min="0" max="50" value="20">
        </div>

        <div class="weight-total">
          Total Weight: <span id="totalWeight">100</span>%
        </div>
      </div>

      <div class="input-group">
        <label>Complex Work Target:</label>
        <input type="number" id="complexPercentage" value="30" min="0" max="100" step="5">%
      </div>

      <div class="input-group">
        <label>Reserve for Surprise Time:</label>
        <input type="number" id="reservePercentage" value="15" min="0" max="50" step="5">%
      </div>

      <div class="input-group">
        <label>Due Date Buffer (days):</label>
        <input type="number" id="dueBuffer" value="2" min="0" max="7" step="1">
      </div>
    </div>

    <button class="btn" id="generateBtn">Generate Schedule</button>
    <button class="btn secondary" id="resetBtn">Reset to Defaults</button>
    <button class="btn success" id="refreshBtn">Refresh Data</button>
  </div>

  <div class="schedule-container">
    <h3>üìÖ Today's Recommended Schedule</h3>
    <div id="scheduleOutput">
      <div class="loading">Click 'Generate Schedule' to begin or 'Refresh Data' to load from API...</div>
    </div>
  </div>

  <script>
    // Global variables
    const API_URL = '/api/notion-proxy';
    let projectsData = [];
    let milestonesData = [];
    let isDataLoaded = false;

    // Sample data fallback for testing
    const sampleData = {
      projects: [
        {
          id: '1',
          name: 'Acoustic Guitar Setup',
          status: 'On The Bench',
          complexity: 2,
          dueDate: '2024-01-15',
          instrumentMake: 'Taylor',
          instrumentModel: '814ce'
        },
        {
          id: '2', 
          name: 'Electric Guitar Rewire',
          status: 'On The Bench',
          complexity: 4,
          dueDate: '2024-01-20',
          instrumentMake: 'Fender',
          instrumentModel: 'Stratocaster'
        }
      ],
      milestones: [
        { id: 'm1', projectId: '1', name: 'Initial inspection', status: 'Ready', estimatedHours: 0.5, order: 1 },
        { id: 'm2', projectId: '1', name: 'String replacement', status: 'Not Started', estimatedHours: 1.0, order: 2 },
        { id: 'm3', projectId: '2', name: 'Disassemble electronics', status: 'Ready', estimatedHours: 2.0, order: 1 },
        { id: 'm4', projectId: '2', name: 'Install new wiring', status: 'Not Started', estimatedHours: 3.0, order: 2 }
      ]
    };

    // Dropdown toggle function
    function toggleAdjustments() {
      const dropdown = document.getElementById('adjustments-dropdown');
      const arrow = document.getElementById('dropdown-arrow');
      const toggleText = document.querySelector('#adjustments-toggle span');
      
      if (dropdown.classList.contains('expanded')) {
        dropdown.classList.remove('expanded');
        arrow.classList.remove('expanded');
        toggleText.textContent = 'Show Adjustments';
      } else {
        dropdown.classList.add('expanded');
        arrow.classList.add('expanded');
        toggleText.textContent = 'Hide Adjustments';
      }
    }

    // Load data function
    async function loadDataFromAPI() {
      try {
        console.log('Attempting to load data from API...');
        const response = await fetch(API_URL, { 
          headers: { 'Accept': 'application/json' } 
        });
        
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.projects || !data.milestones) {
          throw new Error('Invalid data format received from API');
        }

        projectsData = data.projects.filter(p => p.status === 'On The Bench');
        milestonesData = data.milestones;
        isDataLoaded = true;
        console.log('Data loaded successfully from API');
        return true;
        
      } catch (error) {
        console.error('API failed, using sample data:', error);
        projectsData = sampleData.projects;
        milestonesData = sampleData.milestones;
        isDataLoaded = true;
        
        document.getElementById('scheduleOutput').innerHTML = `
          <div class="error">
            Unable to connect to API: ${error.message}<br>
            Using sample data for demonstration. Click 'Generate Schedule' to continue.
          </div>`;
        return true;
      }
    }

    // Generate schedule function
    async function generateSchedule() {
      console.log('Generate schedule called');
      
      if (!isDataLoaded) {
        document.getElementById('scheduleOutput').innerHTML = '<div class="loading">Loading data...</div>';
        await loadDataFromAPI();
      }

      if (projectsData.length === 0) {
        document.getElementById('scheduleOutput').innerHTML = `
          <div class="milestone-item">
            <div style="font-weight: bold; margin-bottom: 8px;">üéØ No active projects found</div>
            <div style="color: var(--muted);">No projects with status "On The Bench" available for scheduling.</div>
          </div>`;
        return;
      }

      // Simple scheduling logic for demonstration
      const availableHours = parseFloat(document.getElementById('availableHours').value) || 8;
      const ready = getReadyMilestones();
      
      if (ready.length === 0) {
        document.getElementById('scheduleOutput').innerHTML = `
          <div class="milestone-item">
            <div style="font-weight: bold; margin-bottom: 8px;">üéâ No ready milestones found</div>
            <div style="color: var(--muted);">All current milestones are either completed or waiting for dependencies.</div>
          </div>`;
        return;
      }

      let html = '';
      let totalHours = 0;
      
      ready.forEach((item, index) => {
        if (totalHours >= availableHours) return;
        
        const hours = Math.min(item.milestone.estimatedHours || 1, availableHours - totalHours);
        totalHours += hours;
        
        html += `
          <div class="milestone-item">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div style="font-weight: bold;">${item.project.name} - ${item.project.instrumentMake || ''} ${item.project.instrumentModel || ''}</div>
              <div style="background: var(--blue); color: white; padding: 4px 10px; border-radius: 999px; font-size: 12px;">
                ${hours.toFixed(1)}h
              </div>
            </div>
            <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">
              Complexity: ${item.project.complexity || 3} ‚Ä¢ Status: ${item.milestone.status}
            </div>
            <div style="font-style: italic;">Milestone: ${item.milestone.name}</div>
          </div>`;
      });

      html += `
        <div style="background: var(--gray-200); padding: 14px; border-radius: 6px; margin-top: 18px; text-align: center;">
          <strong>Schedule Summary:</strong> ${totalHours.toFixed(1)}h scheduled of ${availableHours.toFixed(1)}h available<br>
          <strong>Projects scheduled:</strong> ${ready.length} milestones from ${projectsData.length} active projects
        </div>`;

      document.getElementById('scheduleOutput').innerHTML = html;
    }

    // Get ready milestones
    function getReadyMilestones() {
      const ready = [];
      projectsData.forEach(project => {
        const projectMilestones = milestonesData
          .filter(m => m.projectId === project.id)
          .sort((a, b) => (a.order || 0) - (b.order || 0));
          
        for (let i = 0; i < projectMilestones.length; i++) {
          const milestone = projectMilestones[i];
          if (milestone.status === 'Completed') continue;
          
          const previous = projectMilestones[i - 1];
          const canStart = !previous || previous.status === 'Completed';
          
          if (canStart && (milestone.status === 'Ready' || milestone.status === 'Not Started')) {
            ready.push({ milestone, project });
            break;
          }
        }
      });
      return ready;
    }

    // Update weights
    function updateWeights() {
      const due = parseInt(document.getElementById('dueDateSlider').value) || 0;
      const complex = parseInt(document.getElementById('complexitySlider').value) || 0;
      const age = parseInt(document.getElementById('daysWorkedSlider').value) || 0;
      const quick = parseInt(document.getElementById('quickSlider').value) || 0;
      
      document.getElementById('dueDateWeight').textContent = due;
      document.getElementById('complexityWeight').textContent = complex;
      document.getElementById('daysWorkedWeight').textContent = age;
      document.getElementById('quickWeight').textContent = quick;
      document.getElementById('totalWeight').textContent = (due + complex + age + quick);
    }

    // Reset weights
    function resetWeights() {
      document.getElementById('dueDateSlider').value = 40;
      document.getElementById('complexitySlider').value = 30;
      document.getElementById('daysWorkedSlider').value = 10;
      document.getElementById('quickSlider').value = 20;
      document.getElementById('complexPercentage').value = 30;
      document.getElementById('reservePercentage').value = 15;
      document.getElementById('dueBuffer').value = 2;
      updateWeights();
    }

    // Refresh data
    async function refreshData() {
      isDataLoaded = false;
      document.getElementById('scheduleOutput').innerHTML = '<div class="loading">Refreshing data...</div>';
      await loadDataFromAPI();
      await generateSchedule();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up event listeners');
      
      // Dropdown toggle
      document.getElementById('adjustments-toggle').addEventListener('click', toggleAdjustments);
      
      // Main buttons
      document.getElementById('generateBtn').addEventListener('click', generateSchedule);
      document.getElementById('resetBtn').addEventListener('click', resetWeights);
      document.getElementById('refreshBtn').addEventListener('click', refreshData);
      
      // Slider updates
      const sliders = ['dueDateSlider', 'complexitySlider', 'daysWorkedSlider', 'quickSlider'];
      sliders.forEach(sliderId => {
        const slider = document.getElementById(sliderId);
        if (slider) {
          slider.addEventListener('input', updateWeights);
        }
      });
      
      // Initialize weights
      updateWeights();
      
      console.log('Event listeners set up successfully');
    });
  </script>
</body>
</html>
