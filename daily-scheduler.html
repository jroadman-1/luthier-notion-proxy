<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luthier Daily Scheduler</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --card: #ffffff;
      --ink: #2c3e50;
      --muted: #666;
      --line: rgba(0,0,0,0.08);
      --blue: #3498db;
      --blue-700: #2980b9;
      --green: #27ae60;
      --green-700: #1f8a4d;
      --amber: #f39c12;
      --red: #e74c3c;
      --violet: #8e44ad;
      --gray-100: #f8f9fa;
      --gray-200: #ecf0f1;
      --gray-300: #e9ecef;
    }
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--ink); }
    .header { background: var(--ink); color: #fff; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
    .controls, .schedule-container { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px var(--line); }
    .controls { margin-bottom: 20px; }
    .input-group { margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
    .input-group label { width: 230px; font-weight: bold; }
    .input-group input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 120px; }
    .priority-weights { background: var(--gray-100); padding: 15px; border-radius: 6px; margin: 15px 0; }
    .slider-group { margin-bottom: 12px; }
    .slider-group label { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px; }
    .slider-group input[type="range"] { width: 100%; }
    .weight-total { font-weight: bold; text-align: center; margin-top: 10px; padding: 8px; background: var(--gray-300); border-radius: 4px; }
    .btn { background: var(--blue); color: #fff; border: 0; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 8px; }
    .btn:hover { background: var(--blue-700); }
    .btn.secondary { background: #95a5a6; }
    .btn.success { background: var(--green); }
    .btn.success:hover { background: var(--green-700); }

    .milestone-item { background: var(--gray-100); border-left: 4px solid var(--blue); padding: 14px; margin-bottom: 10px; border-radius: 6px; }
    .milestone-item.complex { border-left-color: var(--red); background: #fdf2f2; }
    .milestone-item.completed { opacity: 0.6; background: #d4edda; border-left-color: #28a745; }
    .milestone-row { display: flex; align-items: flex-start; gap: 12px; }
    .milestone-checkbox { transform: scale(1.4); margin-top: 4px; cursor: pointer; }
    .milestone-content { flex: 1; }
    .milestone-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .milestone-title { font-weight: bold; color: var(--ink); }
    .milestone-time { background: var(--blue); color: #fff; padding: 4px 10px; border-radius: 999px; font-size: 12px; }
    .milestone-time.complex { background: var(--red); }
    .milestone-details { color: var(--muted); font-size: 13px; margin-bottom: 6px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; color: #fff; font-size: 11px; font-weight: bold; }
    .complexity-1 { background: #27ae60; }
    .complexity-2 { background: #f39c12; }
    .complexity-3 { background: #e67e22; }
    .complexity-4 { background: #e74c3c; }
    .complexity-5 { background: #8e44ad; }
    .badge.quick { background: #34495e; }

    .summary { background: var(--gray-200); padding: 14px; border-radius: 6px; margin-top: 18px; text-align: center; }
    .loading { text-align: center; padding: 20px; color: var(--muted); }
    .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; margin: 10px 0; }

    .time-input-group { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .time-input-group input[type="number"] { width: 100px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; }
    .save-progress-btn, .update-all-btn { background: var(--green); color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; }

    .milestone-name { margin-top: 8px; font-size: 14px; color: var(--ink); }
    .milestone-name-display { font-style: italic; cursor: pointer; padding: 4px; border-radius: 4px; }
    .milestone-name-display:hover { background: rgba(52, 152, 219, 0.1); }
    .milestone-name-input { width: 100%; padding: 6px; border: 2px solid var(--blue); border-radius: 4px; font-size: 14px; background: #fff; }
    .milestone-name-input:focus { outline: none; border-color: var(--blue-700); }
    .edit-controls { display: flex; gap: 6px; margin-top: 4px; }
    .edit-controls button { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .save-name-btn { background: var(--green); color: white; }
    .cancel-name-btn { background: #95a5a6; color: white; }

    .skip-today-btn { background: var(--amber); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 8px; }
    .skip-today-btn:hover { background: #e67e22; }
    
    .postponed-section { background: #fff3cd; border: 2px solid var(--amber); border-radius: 8px; padding: 16px; margin-top: 20px; }
    .postponed-section h4 { margin: 0 0 12px 0; color: var(--ink); }
    .postponed-item { background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .restore-btn { background: var(--green); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .restore-btn:hover { background: var(--green-700); }

    .controls-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .dropdown-toggle { background: none; border: none; color: var(--blue); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 4px; transition: background-color 0.2s; }
    .dropdown-toggle:hover { background: var(--gray-100); }
    .dropdown-arrow { transition: transform 0.3s ease; font-size: 12px; }
    .dropdown-arrow.expanded { transform: rotate(180deg); }
    .adjustments-dropdown { max-height: 0; overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; opacity: 0; }
    .adjustments-dropdown.expanded { max-height: 800px; opacity: 1; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé∏ Luthier Daily Scheduler</h1>
    <p>Smart scheduling with complexity balance, quick wins, and due-date buffers</p>
  </div>

  <div class="controls">
    <div class="controls-header">
      <h3>‚öôÔ∏è Scheduling Controls</h3>
      <button class="dropdown-toggle" id="adjustments-toggle">
        <span>Show Adjustments</span>
        <span class="dropdown-arrow" id="dropdown-arrow">‚ñº</span>
      </button>
    </div>

    <div class="input-group">
      <label>Available Hours Today:</label>
      <input type="number" id="availableHours" value="8" min="1" max="16" step="0.5">
    </div>

    <div class="adjustments-dropdown" id="adjustments-dropdown">
      <div class="priority-weights">
        <h4>Priority Weight Adjustments</h4>
        <div class="slider-group">
          <label><span>Due Date Urgency</span><span><span id="dueDateWeight">40</span>%</span></label>
          <input type="range" id="dueDateSlider" min="0" max="80" value="40">
        </div>
        <div class="slider-group">
          <label><span>Complexity Priority</span><span><span id="complexityWeight">30</span>%</span></label>
          <input type="range" id="complexitySlider" min="0" max="80" value="30">
        </div>
        <div class="slider-group">
          <label><span>Days Since Worked</span><span><span id="daysWorkedWeight">10</span>%</span></label>
          <input type="range" id="daysWorkedSlider" min="0" max="50" value="10">
        </div>
        <div class="slider-group">
          <label><span>Quick Wins Boost</span><span><span id="quickWeight">20</span>%</span></label>
          <input type="range" id="quickSlider" min="0" max="50" value="20">
        </div>
        <div class="weight-total">Total Weight: <span id="totalWeight">100</span>%</div>
      </div>
      <div class="input-group">
        <label>Complex Work Target:</label>
        <input type="number" id="complexPercentage" value="30" min="0" max="100" step="5">%
      </div>
      <div class="input-group">
        <label>Reserve for Surprise Time:</label>
        <input type="number" id="reservePercentage" value="15" min="0" max="50" step="5">%
      </div>
      <div class="input-group">
        <label>Due Date Buffer (days):</label>
        <input type="number" id="dueBuffer" value="2" min="0" max="7" step="1">
      </div>
    </div>

    <button class="btn" id="generateBtn">Generate Schedule</button>
    <button class="btn secondary" id="resetBtn">Reset to Defaults</button>
    <button class="btn success" id="refreshBtn">Refresh Data</button>
  </div>

  <div class="schedule-container">
    <h3>üìÖ Today's Recommended Schedule</h3>
    <div id="scheduleOutput"><div class="loading">Loading project data...</div></div>
  </div>

  <script>
    const API_URL = '/api/notion-proxy';
    let projectsData = [], milestonesData = [], isDataLoaded = false, postponedProjects = [];

    // Event delegation setup
    document.addEventListener('DOMContentLoaded', function() {
      // Control buttons
      document.getElementById('adjustments-toggle').addEventListener('click', toggleAdjustments);
      document.getElementById('generateBtn').addEventListener('click', generateSchedule);
      document.getElementById('resetBtn').addEventListener('click', resetWeights);
      document.getElementById('refreshBtn').addEventListener('click', refreshData);
      
      // Sliders
      document.getElementById('dueDateSlider').addEventListener('input', updateWeights);
      document.getElementById('complexitySlider').addEventListener('input', updateWeights);
      document.getElementById('daysWorkedSlider').addEventListener('input', updateWeights);
      document.getElementById('quickSlider').addEventListener('input', updateWeights);
      
      // Event delegation for dynamic elements
      document.getElementById('scheduleOutput').addEventListener('click', function(e) {
        const target = e.target;
        
        // Skip Today button
        if (target.classList.contains('skip-today-btn')) {
          const projectId = target.dataset.projectId;
          const projectName = target.dataset.projectName;
          postponeProject(projectId, projectName);
        }
        
        // Restore button
        if (target.classList.contains('restore-btn')) {
          const projectId = target.dataset.projectId;
          restoreProject(projectId);
        }
        
        // Save Progress button
        if (target.classList.contains('save-progress-btn')) {
          const milestoneId = target.dataset.milestoneId;
          const projectId = target.dataset.projectId;
          saveMilestoneProgress(milestoneId, projectId);
        }
        
        // Update All button
        if (target.id === 'updateAllBtn') {
          saveAllProgress();
        }
        
        // Milestone name display
        if (target.classList.contains('milestone-name-display')) {
          const milestoneId = target.dataset.milestoneId;
          startEditingMilestoneName(milestoneId);
        }
        
        // Save name button
        if (target.classList.contains('save-name-btn')) {
          const milestoneId = target.dataset.milestoneId;
          saveMilestoneName(milestoneId);
        }
        
        // Cancel name button
        if (target.classList.contains('cancel-name-btn')) {
          const milestoneId = target.dataset.milestoneId;
          cancelEditingMilestoneName(milestoneId);
        }
      });
      
      // Checkbox changes
      document.getElementById('scheduleOutput').addEventListener('change', function(e) {
        if (e.target.classList.contains('milestone-checkbox')) {
          const milestoneId = e.target.dataset.milestoneId;
          toggleMilestoneCompletion(milestoneId);
        }
      });
      
      // Keydown for milestone name input
      document.getElementById('scheduleOutput').addEventListener('keydown', function(e) {
        if (e.target.classList.contains('milestone-name-input')) {
          const milestoneId = e.target.dataset.milestoneId;
          if (e.key === 'Enter') {
            saveMilestoneName(milestoneId);
          } else if (e.key === 'Escape') {
            cancelEditingMilestoneName(milestoneId);
          }
        }
      });
      
      // Initialize
      generateSchedule();
    });

    function toggleAdjustments() {
      const dropdown = document.getElementById('adjustments-dropdown');
      const arrow = document.getElementById('dropdown-arrow');
      const toggleText = document.querySelector('#adjustments-toggle span');
      if (dropdown.classList.contains('expanded')) {
        dropdown.classList.remove('expanded');
        arrow.classList.remove('expanded');
        toggleText.textContent = 'Show Adjustments';
      } else {
        dropdown.classList.add('expanded');
        arrow.classList.add('expanded');
        toggleText.textContent = 'Hide Adjustments';
      }
    }

    async function loadDataFromAPI() {
      try {
        const res = await fetch(API_URL, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`API request failed: ${res.status} ${res.statusText}`);
        const data = await res.json();
        if (!data.projects || !data.milestones) throw new Error('Invalid data format received from API');
        projectsData = data.projects.filter(p => p.status === 'On The Bench');
        milestonesData = data.milestones;
        isDataLoaded = true;
        return true;
      } catch (error) {
        console.error('Failed to load data from API:', error);
        document.getElementById('scheduleOutput').innerHTML = `<div class="error">Failed to load project data: ${error.message}<br>Please check your API connection and try refreshing.</div>`;
        return false;
      }
    }

    function getReadyMilestones() {
      if (!isDataLoaded || projectsData.length === 0) return [];
      const ready = [];
      projectsData.forEach(project => {
        if (postponedProjects.includes(project.id)) return;
        const projectMilestones = milestonesData.filter(m => m.projectId === project.id).sort((a, b) => a.order - b.order);
        for (let i = 0; i < projectMilestones.length; i++) {
          const milestone = projectMilestones[i];
          if (milestone.status === 'Completed') continue;
          const previous = projectMilestones[i - 1];
          const canStart = !previous || previous.status === 'Completed';
          if (canStart && (milestone.status === 'Ready' || milestone.status === 'Not Started')) {
            ready.push({ milestone, project });
            break;
          }
        }
      });
      return ready;
    }

    function clamp(x, min, max) { return Math.max(min, Math.min(max, x)); }
    function totalProjectHours(projectId) {
      return milestonesData.filter(m => m.projectId === projectId && m.status !== 'Completed').reduce((acc, m) => acc + (m.estimatedHours || 0), 0);
    }
    function isQuickWin(task) {
      const c = Number(task.project.complexity) || 3;
      if (c >= 4) return false;
      return totalProjectHours(task.project.id) <= 2;
    }
    function remainingComplexMilestones(projectId) {
      const project = projectsData.find(p => p.id === projectId);
      const isComplexProject = (project?.complexity || 3) >= 4;
      if (!isComplexProject) return 0;
      return milestonesData.filter(m => m.projectId === projectId && m.status !== 'Completed').length;
    }
    function daysUntilDueCalendar(dueStr) {
      if (!dueStr) return 9999;
      const t = new Date();
      const today0 = new Date(t.getFullYear(), t.getMonth(), t.getDate());
      const d = new Date(dueStr);
      const due0 = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      return Math.round((due0 - today0) / (1000 * 60 * 60 * 24));
    }
    function getDaysSinceWorked(project, today) {
      const parse = s => (s ? new Date(s) : null);
      const ref = parse(project.lastWorked) || parse(project.intakeDate) || parse(project.dateCreated) || parse(project.createdTime);
      if (!ref) return null;
      return Math.max(0, Math.floor((today - ref) / (1000 * 60 * 60 * 24)));
    }

    function calculatePriorities(readyTasks) {
      const today = new Date();
      const dueBufferDays = parseInt(document.getElementById('dueBuffer').value) || 2;
      const w_due = parseInt(document.getElementById('dueDateSlider').value) || 0;
      const w_complex = parseInt(document.getElementById('complexitySlider').value) || 0;
      const w_age = parseInt(document.getElementById('daysWorkedSlider').value) || 0;
      const w_quick = parseInt(document.getElementById('quickSlider').value) || 0;
      const w_sum = Math.max(1, w_due + w_complex + w_age + w_quick);
      const W = { due: w_due / w_sum, complex: w_complex / w_sum, age: w_age / w_sum, quick: w_quick / w_sum };

      const scored = readyTasks.map(task => {
        const daysUntilDue = daysUntilDueCalendar(task.project.dueDate);
        const rawDSW = getDaysSinceWorked(task.project, today);
        const daysSinceWorked = rawDSW ?? 0;
        const overdue = daysUntilDue < 0;
        const dueUrgencyBuffered = overdue ? 1 : clamp((dueBufferDays - daysUntilDue) / dueBufferDays, 0, 1);
        const complexityScore = ((task.project.complexity || 3) / 5);
        const neglectBoost = clamp(daysSinceWorked / 14, 0, 1);
        const quickWinBoost = isQuickWin(task) ? 1 : 0;
        const complexLeft = remainingComplexMilestones(task.project.id);
        const workDaysRemaining = Math.max(1, (overdue ? 0 : daysUntilDue) - dueBufferDays);
        const distributionFactor = (task.project.complexity || 3) >= 4 ? clamp(complexLeft / workDaysRemaining, 0, 1) : 0;
        let score = W.due * dueUrgencyBuffered + W.complex * complexityScore + W.age * neglectBoost + W.quick * quickWinBoost;
        score += 0.15 * distributionFactor;
        if (overdue) score += 2.0;
        return { ...task, score, daysUntilDue, daysSinceWorked, overdue, isComplex: (task.project.complexity || 3) >= 4, isQuick: quickWinBoost === 1 };
      });
      return scored.sort((a, b) => b.score - a.score);
    }

    function balanceComplexity(prioritizedTasks, availableHoursInput) {
      const reservePct = parseInt(document.getElementById('reservePercentage').value) || 15;
      const complexTargetPct = (parseInt(document.getElementById('complexPercentage').value) || 30) / 100;
      const availableHours = Math.max(0, availableHoursInput * (1 - reservePct / 100));
      const schedule = [];
      let totalHours = 0, complexHours = 0;
      const usedMilestones = new Set(), complexProjectsScheduled = new Set();

      function tryAdd(task) {
        if (usedMilestones.has(task.milestone.id)) return false;
        const h = task.milestone.estimatedHours || 0;
        if (h <= 0) return false;
        if (totalHours + h > availableHours + 1e-6) return false;
        if (task.isComplex && complexProjectsScheduled.has(task.project.id) && !task.overdue) {
          const needMoreComplex = complexHours < (availableHours * complexTargetPct) - 1e-6;
          if (!needMoreComplex) return false;
        }
        schedule.push({ ...task, scheduledHours: h });
        totalHours += h;
        if (task.isComplex) { complexHours += h; complexProjectsScheduled.add(task.project.id); }
        usedMilestones.add(task.milestone.id);
        return true;
      }

      const overdue = prioritizedTasks.filter(t => t.overdue);
      const quickWins = prioritizedTasks.filter(t => t.isQuick);
      const complex = prioritizedTasks.filter(t => t.isComplex);
      const simple = prioritizedTasks.filter(t => !t.isComplex);

      for (const t of overdue) { if (totalHours >= availableHours) break; tryAdd(t); }
      if (totalHours < availableHours && quickWins.length) { for (const t of quickWins) { if (tryAdd(t)) break; } }
      let guard = 0;
      while (totalHours < availableHours && guard++ < 500) {
        const needComplex = complexHours < (availableHours * complexTargetPct) - 1e-6;
        let picked = false;
        if (needComplex) {
          for (const t of complex) { if (tryAdd(t)) { picked = true; break; } }
          if (!picked) { for (const t of simple) { if (tryAdd(t)) { picked = true; break; } } }
        } else {
          for (const t of simple) { if (tryAdd(t)) { picked = true; break; } }
          if (!picked) { for (const t of complex) { if (tryAdd(t)) { picked = true; break; } } }
        }
        if (!picked) break;
      }
      return { schedule, totalHours, complexHours, availableHours };
    }

    function isProjectOverdue(project) {
      const days = daysUntilDueCalendar(project?.dueDate);
      return typeof days === 'number' && days < 0 && project?.status !== 'Done';
    }
    function getOverdueRemainingMilestones() {
      if (!isDataLoaded || projectsData.length === 0) return [];
      const tasks = [];
      const overdueProjects = projectsData.filter(p => isProjectOverdue(p) && !postponedProjects.includes(p.id));
      overdueProjects.forEach(project => {
        const remaining = milestonesData.filter(m => m.projectId === project.id && m.status !== 'Completed').sort((a, b) => (a.order || 0) - (b.order || 0));
        remaining.forEach(m => tasks.push({ milestone: m, project }));
      });
      return tasks;
    }
    function dedupeByMilestone(arr) {
      const seen = new Set(), out = [];
      for (const x of arr) { if (!seen.has(x.milestone.id)) { seen.add(x.milestone.id); out.push(x); } }
      return out;
    }

    function postponeProject(projectId, projectName) {
      if (!postponedProjects.includes(projectId)) {
        postponedProjects.push(projectId);
        console.log(`Postponed project: ${projectName} (${projectId})`);
        generateSchedule();
      }
    }
    function restoreProject(projectId) {
      const index = postponedProjects.indexOf(projectId);
      if (index > -1) {
        postponedProjects.splice(index, 1);
        console.log(`Restored project: ${projectId}`);
        generateSchedule();
      }
    }
    function displayPostponedProjects() {
      if (postponedProjects.length === 0) return '';
      let html = '<div class="postponed-section"><h4>‚è≠Ô∏è Postponed Until Tomorrow</h4>';
      postponedProjects.forEach(projectId => {
        const project = projectsData.find(p => p.id === projectId);
        if (project) {
          const safeName = project.name.replace(/"/g, '&quot;');
          html += `<div class="postponed-item"><div><strong>${project.name}</strong> - ${project.instrumentMake || ''} ${project.instrumentModel || ''} <span class="badge complexity-${project.complexity || 3}">C${project.complexity || 3}</span></div><button class="restore-btn" data-project-id="${projectId}">Restore to Schedule</button></div>`;
        }
      });
      html += '</div>';
      return html;
    }

    function startEditingMilestoneName(milestoneId) {
      const displayEl = document.getElementById(`name-display-${milestoneId}`);
      const inputEl = document.getElementById(`name-input-${milestoneId}`);
      const controlsEl = document.getElementById(`name-controls-${milestoneId}`);
      if (displayEl && inputEl && controlsEl) {
        displayEl.style.display = 'none';
        inputEl.style.display = 'block';
        controlsEl.style.display = 'flex';
        inputEl.focus();
        inputEl.select();
      }
    }
    function cancelEditingMilestoneName(milestoneId) {
      const displayEl = document.getElementById(`name-display-${milestoneId}`);
      const inputEl = document.getElementById(`name-input-${milestoneId}`);
      const controlsEl = document.getElementById(`name-controls-${milestoneId}`);
      if (displayEl && inputEl && controlsEl) {
        displayEl.style.display = 'block';
        inputEl.style.display = 'none';
        controlsEl.style.display = 'none';
        const milestone = milestonesData.find(m => m.id === milestoneId);
        if (milestone) inputEl.value = milestone.name;
      }
    }
    async function saveMilestoneName(milestoneId) {
      const inputEl = document.getElementById(`name-input-${milestoneId}`);
      const displayEl = document.getElementById(`name-display-${milestoneId}`);
      const controlsEl = document.getElementById(`name-controls-${milestoneId}`);
      if (!inputEl || !displayEl || !controlsEl) return;
      const newName = inputEl.value.trim();
      if (!newName) { alert('Milestone name cannot be empty'); inputEl.focus(); return; }
      try {
        const response = await fetch(`${API_URL}?action=update-milestone`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ milestoneId: milestoneId, name: newName })
        });
        if (!response.ok) throw new Error(`Failed to update milestone name: ${response.statusText}`);
        const milestone = milestonesData.find(m => m.id === milestoneId);
        if (milestone) milestone.name = newName;
        displayEl.textContent = newName;
        displayEl.style.display = 'block';
        inputEl.style.display = 'none';
        controlsEl.style.display = 'none';
        console.log('Milestone name updated successfully');
      } catch (error) {
        alert('Failed to update milestone name: ' + error.message);
        console.error('Error updating milestone name:', error);
      }
    }

    function displaySchedule(result, effectiveHours) {
      const { schedule, totalHours, complexHours } = result;
      let html = '';
      if (schedule.length === 0) {
        html = `<div class="milestone-item"><div class="milestone-title">üéâ No milestones ready for scheduling!</div><div class="milestone-details">All current milestones are either completed or waiting for previous tasks to finish.</div></div>`;
      } else {
        schedule.forEach((item, index) => {
          const dueText = item.daysUntilDue < 0 ? '‚ö†Ô∏è OVERDUE!' : item.daysUntilDue <= 3 ? 'üî• Due soon' : item.daysUntilDue <= 7 ? 'üìÖ Due this week' : '‚úÖ On track';
          const dsw = (typeof item.daysSinceWorked === 'number') ? item.daysSinceWorked : null;
          const workedText = dsw === null ? '' : dsw === 0 ? 'üü¢ touched today' : dsw === 1 ? '‚è∞ 1 day since worked' : `‚è∞ ${dsw} days since worked`;
          const complexClass = item.isComplex ? 'complex' : '';
          const timeClass = item.isComplex ? 'complex' : '';
          const completedClass = item.milestone.status === 'Completed' ? 'completed' : '';
          const safeName = item.project.name.replace(/"/g, '&quot;');
          html += `
            <div class="milestone-item ${complexClass} ${completedClass}" id="milestone-${item.milestone.id}">
              <div class="milestone-row">
                <input type="checkbox" class="milestone-checkbox" data-milestone-id="${item.milestone.id}" ${item.milestone.status === 'Completed' ? 'checked disabled' : ''} id="checkbox-${item.milestone.id}">
                <div class="milestone-content">
                  <div class="milestone-header">
                    <div class="milestone-title">${item.project.name} - ${item.project.instrumentMake || ''} ${item.project.instrumentModel || ''}</div>
                    <div class="milestone-time ${timeClass}">${(item.scheduledHours || 0).toFixed(1)}h</div>
                  </div>
                  <div class="milestone-details">
                    <span class="badge complexity-${item.project.complexity || 3}">C${item.project.complexity || 3}</span>
                    ${item.isQuick ? '<span class="badge quick">Quick</span>' : ''}
                    <span>${dueText}</span>
                    <span>‚Ä¢ Priority: ${item.score.toFixed(2)}</span>
                    ${workedText ? `<span>‚Ä¢ ${workedText}</span>` : ''}
                  </div>
                  <div class="milestone-name">
                    <span>Milestone: </span>
                    <span class="milestone-name-display" data-milestone-id="${item.milestone.id}" id="name-display-${item.milestone.id}" title="Click to edit milestone name">${item.milestone.name}</span>
                    <input type="text" class="milestone-name-input" data-milestone-id="${item.milestone.id}" id="name-input-${item.milestone.id}" value="${item.milestone.name}" style="display: none;">
                    <div class="edit-controls" id="name-controls-${item.milestone.id}" style="display: none;">
                      <button class="save-name-btn" data-milestone-id="${item.milestone.id}">Save</button>
                      <button class="cancel-name-btn" data-milestone-id="${item.milestone.id}">Cancel</button>
                    </div>
                  </div>
                  <button class="skip-today-btn" data-project-id="${item.project.id}" data-project-name="${safeName}">‚è≠Ô∏è Skip Today</button>
                  <div class="completion-controls" id="controls-${item.milestone.id}">
                    <div class="time-input-group">
                      <label>Actual hours:</label>
                      <input type="number" step="0.25" min="0.25" max="24" value="${(item.scheduledHours || 0).toFixed(1)}" id="actual-hours-${item.milestone.id}" placeholder="Hours">
                      <button class="save-progress-btn" data-milestone-id="${item.milestone.id}" data-project-id="${item.project.id}" id="save-btn-${item.milestone.id}">Save Progress</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>`;
        });
        html += `<div style="text-align:center; margin-top: 12px;"><button class="update-all-btn" id="updateAllBtn">Update All Completed Milestones</button></div>`;
      }
      const complexPct = totalHours > 0 ? Math.round((complexHours / totalHours) * 100) : 0;
      const targetPct = parseInt(document.getElementById('complexPercentage').value) || 30;
      html += `<div class="summary"><strong>Schedule Summary:</strong> ${totalHours.toFixed(1)}h scheduled of ${effectiveHours.toFixed(1)}h available<br><strong>Complex work (4‚Äì5):</strong> ${complexHours.toFixed(1)}h (${complexPct}%) ${complexPct < targetPct ? ` ‚ö†Ô∏è Below ${targetPct}% target!` : ` ‚úÖ Good balance!`}<br><strong>Projects scheduled:</strong> ${schedule.length > 0 ? [...new Set(schedule.map(s => s.project.name))].length : 0} of ${projectsData.length} active projects</div>`;
      html += displayPostponedProjects();
      document.getElementById('scheduleOutput').innerHTML = html;
    }

    function toggleMilestoneCompletion(milestoneId) {
      const checkbox = document.getElementById(`checkbox-${milestoneId}`);
      const controls = document.getElementById(`controls-${milestoneId}`);
      const item = document.getElementById(`milestone-${milestoneId}`);
      if (checkbox.checked) {
        controls.classList.add('show');
        item.classList.add('completed');
        setTimeout(() => document.getElementById(`actual-hours-${milestoneId}`).focus(), 100);
      } else {
        controls.classList.remove('show');
        item.classList.remove('completed');
      }
    }

    async function saveMilestoneProgress(milestoneId, projectId) {
      const actualHoursInput = document.getElementById(`actual-hours-${milestoneId}`);
      const saveBtn = document.getElementById(`save-btn-${milestoneId}`);
      const checkbox = document.getElementById(`checkbox-${milestoneId}`);
      if (!checkbox.checked) { alert('Please check the milestone as completed first.'); return; }
      const actualHours = parseFloat(actualHoursInput.value);
      if (!actualHours || actualHours <= 0) { alert('Please enter a valid number of hours.'); actualHoursInput.focus(); return; }
      try {
        saveBtn.textContent = 'Saving...'; saveBtn.disabled = true;
        const response = await fetch(`${API_URL}?action=save-progress`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completedMilestones: [{ milestoneId, projectId, actualHours }]})
        });
        if (!response.ok) throw new Error(`Failed to save progress: ${response.statusText}`);
        await response.json();
        saveBtn.textContent = '‚úì Saved'; saveBtn.style.background = '#28a745';
        checkbox.disabled = true; actualHoursInput.disabled = true;
        const milestone = milestonesData.find(m => m.id === milestoneId);
        if (milestone) { milestone.status = 'Completed'; milestone.actualHours = actualHours; }
      } catch (err) {
        alert('Failed to save progress: ' + err.message);
        saveBtn.textContent = 'Save Progress'; saveBtn.disabled = false;
      }
    }

    async function saveAllProgress() {
      const updateBtn = document.getElementById('updateAllBtn');
      const completed = [];
      const checkboxes = document.querySelectorAll('.milestone-checkbox:checked:not(:disabled)');
      for (const cb of checkboxes) {
        const milestoneId = cb.dataset.milestoneId;
        const input = document.getElementById(`actual-hours-${milestoneId}`);
        const hours = parseFloat(input.value);
        if (hours && hours > 0) {
          const m = milestonesData.find(mm => mm.id === milestoneId);
          if (m) completed.push({ milestoneId, projectId: m.projectId, actualHours: hours });
        }
      }
      if (!completed.length) { alert('No completed milestones with valid hours found.'); return; }
      try {
        updateBtn.textContent = 'Updating...'; updateBtn.disabled = true;
        const response = await fetch(`${API_URL}?action=save-progress`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completedMilestones: completed })
        });
        if (!response.ok) throw new Error(`Failed to save progress: ${response.statusText}`);
        await response.json();
        completed.forEach(c => {
          const cb = document.getElementById(`checkbox-${c.milestoneId}`);
          const input = document.getElementById(`actual-hours-${c.milestoneId}`);
          const btn = document.getElementById(`save-btn-${c.milestoneId}`);
          if (cb && input && btn) {
            cb.disabled = true; input.disabled = true; btn.textContent = '‚úì Saved'; btn.style.background = '#28a745'; btn.disabled = true;
          }
          const ms = milestonesData.find(m => m.id === c.milestoneId);
          if (ms) { ms.status = 'Completed'; ms.actualHours = c.actualHours; }
        });
        updateBtn.textContent = `‚úì Updated ${completed.length} Milestones`;
        updateBtn.style.background = '#28a745';
        setTimeout(() => { updateBtn.textContent = 'Update All Completed Milestones'; updateBtn.style.background = '#28a745'; updateBtn.disabled = false; }, 3000);
      } catch (err) {
        alert('Failed to save progress: ' + err.message);
        updateBtn.textContent = 'Update All Completed Milestones'; updateBtn.disabled = false;
      }
    }

    async function generateSchedule() {
      if (!isDataLoaded) { const ok = await loadDataFromAPI(); if (!ok) return; }
      const availableHoursInput = parseFloat(document.getElementById('availableHours').value) || 8;
      const ready = getReadyMilestones();
      const overdueAll = getOverdueRemainingMilestones();
      const candidate = dedupeByMilestone([...overdueAll, ...ready]);
      if (!candidate.length) {
        document.getElementById('scheduleOutput').innerHTML = `<div class="milestone-item"><div class="milestone-title">üéØ No ready or overdue milestones found</div><div class="milestone-details">${projectsData.length === 0 ? 'No projects with status "On The Bench" found.' : 'All milestones are either completed or blocked.'}</div></div>`;
        return;
      }
      let prioritized = calculatePriorities(candidate);
      prioritized = prioritized.sort((a, b) => {
        if (a.overdue !== b.overdue) return a.overdue ? -1 : 1;
        if (a.overdue && b.overdue && a.project.id === b.project.id) {
          return (a.milestone.order || 0) - (b.milestone.order || 0);
        }
        return b.score - a.score;
      });
      const result = balanceComplexity(prioritized, availableHoursInput);
      displaySchedule(result, result.availableHours);
    }

    async function refreshData() {
      isDataLoaded = false;
      postponedProjects = [];
      document.getElementById('scheduleOutput').innerHTML = '<div class="loading">Refreshing data...</div>';
      await generateSchedule();
    }

    function updateWeights() {
      const due = parseInt(document.getElementById('dueDateSlider').value) || 0;
      const complex = parseInt(document.getElementById('complexitySlider').value) || 0;
      const age = parseInt(document.getElementById('daysWorkedSlider').value) || 0;
      const quick = parseInt(document.getElementById('quickSlider').value) || 0;
      document.getElementById('dueDateWeight').textContent = due;
      document.getElementById('complexityWeight').textContent = complex;
      document.getElementById('daysWorkedWeight').textContent = age;
      document.getElementById('quickWeight').textContent = quick;
      document.getElementById('totalWeight').textContent = (due + complex + age + quick);
      if (isDataLoaded) generateSchedule();
    }

    function resetWeights() {
      document.getElementById('dueDateSlider').value = 40;
      document.getElementById('complexitySlider').value = 30;
      document.getElementById('daysWorkedSlider').value = 10;
      document.getElementById('quickSlider').value = 20;
      document.getElementById('complexPercentage').value = 30;
      document.getElementById('reservePercentage').value = 15;
      document.getElementById('dueBuffer').value = 2;
      updateWeights();
    }
  </script>
</body>
</html>
