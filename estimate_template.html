<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Estimate - Roadman Guitars</title>
  <style>
    @page { size: letter; margin: 0.5in; }
    * { box-sizing: border-box; }
    body {
      font-family: 'Times New Roman', serif;
      margin: 0; padding: 0; color: #333; line-height: 1.4; font-size: 12px;
    }
    .estimate-container { max-width: 8.5in; margin: 0 auto; background: white; min-height: 11in; padding: 20px; }

    /* Letterhead Section */
    .letterhead {
      border-bottom: 3px solid #2c3e50; margin-bottom: 20px; padding-bottom: 15px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .logo-section {
      flex: 0 0 120px; height: 80px; background: #f8f9fa; border: none;
      display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; text-align: center;
    }
    .company-info { flex: 1; text-align: center; margin: 0 20px; }
    .company-name { font-size: 24px; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
    .company-tagline { font-size: 14px; color: #666; font-style: italic; margin-bottom: 8px; }
    .contact-info { font-size: 11px; color: #555; }
    .report-date { flex: 0 0 140px; text-align: right; font-size: 11px; color: #444; line-height: 1.6; }

    /* Project Header */
    .project-header { background: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 20px; }
    .project-title { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; text-align: center; }
    .project-basic-info { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    .info-item { display: flex; flex-direction: column; }
    .info-label { font-weight: bold; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px; }
    .info-value { font-size: 13px; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 2px; min-height: 16px; }

    /* Estimate Items Section */
    .estimate-section { margin-top: 30px; }
    .section-title { font-size: 16px; font-weight: bold; color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; margin-bottom: 15px; }
    
    .estimate-items { border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; }
    .estimate-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 15px;
      border-bottom: 1px solid #dee2e6;
      background: white;
    }
    .estimate-item:last-child { border-bottom: none; }
    .estimate-item:nth-child(even) { background: #f8f9fa; }
    .item-name { font-size: 13px; color: #333; flex: 1; }
    .item-amount { font-size: 13px; font-weight: bold; color: #2c3e50; min-width: 100px; text-align: right; }

    /* Parts Section */
    .parts-section { margin-top: 30px; }

    /* Total Section - All Grey Styling */
    .estimate-subtotal {
      margin-top: 20px;
      padding: 12px 15px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .subtotal-label { font-size: 14px; font-weight: bold; color: #2c3e50; }
    .subtotal-amount { font-size: 16px; font-weight: bold; color: #2c3e50; }
    
    .estimate-discount {
      margin-top: 10px;
      padding: 12px 15px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .discount-label { font-size: 14px; font-weight: bold; color: #2c3e50; }
    .discount-amount { font-size: 16px; font-weight: bold; color: #2c3e50; }
    
    .estimate-tax {
      margin-top: 10px;
      padding: 12px 15px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .tax-label { font-size: 14px; font-weight: bold; color: #2c3e50; }
    .tax-amount { font-size: 16px; font-weight: bold; color: #2c3e50; }
    
    .estimate-total {
      margin-top: 10px;
      padding: 15px;
      background: #f8f9fa;
      border: 2px solid #2c3e50;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .total-label { font-size: 16px; font-weight: bold; color: #2c3e50; }
    .total-amount { font-size: 20px; font-weight: bold; color: #2c3e50; }

    /* Notes Section */
    .estimate-notes {
      margin-top: 30px;
      padding: 15px;
      background: #fffef0;
      border-left: 4px solid #f0ad4e;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.6;
    }

    @media print {
      body { background: white; }
      .estimate-container { box-shadow: none; }
      @page { margin: 0.5in; }
    }
  </style>
</head>
<body>
  <div class="estimate-container">
    <!-- Letterhead -->
    <div class="letterhead">
      <div class="logo-section">
        LOGO<br>PLACEHOLDER
      </div>
      <div class="company-info">
        <div class="company-name">Roadman Guitars</div>
        <div class="company-tagline">Expert Guitar Setup & Repair</div>
        <div class="contact-info">
          üìß <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c4ada1b7aab6a5abadb6b084a3a9a5ada8eaa7aba9">[email&#160;protected]</a> | üìû (210) 555-XXXX | üìç San Antonio, TX
        </div>
      </div>
      <div class="report-date">
        <strong>ESTIMATE</strong><br>
        <span id="reportDate"></span><br>
        Project ID: <span id="projectIdDisplay"></span>
      </div>
    </div>

    <!-- Project Header -->
    <div class="project-header">
      <div class="project-title" id="projectTitle">Guitar Setup & Repair Estimate</div>
      <div class="project-basic-info">
        <div class="info-item">
          <div class="info-label">Instrument</div>
          <div class="info-value" id="instrumentInfo"></div>
        </div>
        <div class="info-item">
          <div class="info-label">Customer</div>
          <div class="info-value" id="customerName"></div>
        </div>
        <div class="info-item">
          <div class="info-label">Store</div>
          <div class="info-value" id="storeName"></div>
        </div>
      </div>
    </div>

    <!-- Services/Labor Section -->
    <div class="estimate-section">
      <div class="section-title">SERVICES</div>
      <div class="estimate-items" id="servicesItems">
        <!-- Services will be populated by JavaScript -->
      </div>
    </div>

    <!-- Parts Section -->
    <div class="parts-section" id="partsSection" style="display: none;">
      <div class="section-title">PARTS</div>
      <div class="estimate-items" id="partsItems">
        <!-- Parts will be populated by JavaScript -->
      </div>
    </div>

    <!-- Totals Section -->
    <div class="estimate-subtotal">
      <div class="subtotal-label">SUBTOTAL</div>
      <div class="subtotal-amount" id="subtotalAmount">$0.00</div>
    </div>
    
    <div class="estimate-discount" id="discountSection" style="display:none;">
      <div class="discount-label">DISCOUNT</div>
      <div class="discount-amount" id="discountAmount">-$0.00</div>
    </div>
    
    <div class="estimate-tax" id="taxSection" style="display:none;">
      <div class="tax-label" id="taxLabel">TAX</div>
      <div class="tax-amount" id="taxAmount">$0.00</div>
    </div>
    
    <div class="estimate-total">
      <div class="total-label">ESTIMATED TOTAL</div>
      <div class="total-amount" id="totalAmount">$0.00</div>
    </div>

    <!-- Notes -->
    <div class="estimate-notes">
      <p><strong>Note:</strong> This is an estimate based on initial assessment. Final charges may vary depending on actual work required and parts needed.</p>
      <p>Estimate valid for 30 days from date of issue.</p>
      <p>Payment due upon completion. If sales tax it not reflected in the estimate, it will be applied when payment is due.</p>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
  (function(){
    const data = JSON.parse(localStorage.getItem('luthierEstimateData') || '{}');
    const p = data.project || {};
    const milestones = data.milestones || [];
    const parts = data.parts || [];
    
    const HOURLY_RATE = p.hourlyRate || 100;
    
    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value || '';
    }
    
    // Header info
    setText('reportDate', new Date().toLocaleDateString('en-US', { 
      year: 'numeric', month: 'long', day: 'numeric' 
    }));
    setText('projectIdDisplay', p.projectId || 'N/A');
    setText('projectTitle', p.name || 'Guitar Setup & Repair Estimate');
    setText('instrumentInfo', `${p.instrumentMake || ''} ${p.instrumentModel || ''}`.trim() || 'N/A');
    setText('customerName', p.name || 'N/A');
    setText('storeName', p.store || '');
    
    // Calculate subtotal from services and parts
    let subtotal = 0;
    
    // Group milestones by workflowGroupId
    const workflowGroups = {};
    const standaloneMilestones = [];
    
    milestones
      .filter(m => m.includeInEstimate !== false)
      .forEach(milestone => {
        if (milestone.workflowGroupId) {
          if (!workflowGroups[milestone.workflowGroupId]) {
            workflowGroups[milestone.workflowGroupId] = {
              name: milestone.workflowName || 'Workflow Group',
              totalHours: 0,
              milestones: []
            };
          }
          workflowGroups[milestone.workflowGroupId].milestones.push(milestone);
          workflowGroups[milestone.workflowGroupId].totalHours += parseFloat(milestone.estimatedHours) || 0;
        } else {
          standaloneMilestones.push(milestone);
        }
      });
    
    // Build services list
    const itemsContainer = document.getElementById('servicesItems');
    
    if (Object.keys(workflowGroups).length > 0 || standaloneMilestones.length > 0) {
      // Add workflow groups first
      Object.values(workflowGroups).forEach(group => {
        const cost = group.totalHours * HOURLY_RATE;
        subtotal += cost;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'estimate-item';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'item-name';
        nameDiv.textContent = group.name;
        
        const amountDiv = document.createElement('div');
        amountDiv.className = 'item-amount';
        amountDiv.textContent = '$' + cost.toFixed(2);
        
        itemDiv.appendChild(nameDiv);
        itemDiv.appendChild(amountDiv);
        itemsContainer.appendChild(itemDiv);
      });
      
      // Then add standalone milestones
      standaloneMilestones.forEach(milestone => {
        const cost = (parseFloat(milestone.estimatedHours) || 0) * HOURLY_RATE;
        subtotal += cost;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'estimate-item';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'item-name';
        nameDiv.textContent = milestone.name;
        
        const amountDiv = document.createElement('div');
        amountDiv.className = 'item-amount';
        amountDiv.textContent = '$' + cost.toFixed(2);
        
        itemDiv.appendChild(nameDiv);
        itemDiv.appendChild(amountDiv);
        itemsContainer.appendChild(itemDiv);
      });
    } else {
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'estimate-item';
      emptyDiv.style.justifyContent = 'center';
      emptyDiv.style.color = '#999';
      emptyDiv.textContent = 'No services defined for this project';
      itemsContainer.appendChild(emptyDiv);
    }

    // Build parts list
    const partsContainer = document.getElementById('partsItems');
    const partsSection = document.getElementById('partsSection');
    
    if (parts.length > 0) {
      partsSection.style.display = 'block';
      
      parts.forEach(part => {
        const quantity = parseFloat(part.quantity) || 0;
        const pricePerItem = parseFloat(part.pricePerItem) || 0;
        const partTotal = quantity * pricePerItem;
        subtotal += partTotal;

        const partDiv = document.createElement('div');
        partDiv.className = 'estimate-item';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'item-name';
        nameDiv.textContent = part.name + (quantity > 1 ? ' (x' + quantity + ')' : '');
        
        const amountDiv = document.createElement('div');
        amountDiv.className = 'item-amount';
        amountDiv.textContent = '$' + partTotal.toFixed(2);
        
        partDiv.appendChild(nameDiv);
        partDiv.appendChild(amountDiv);
        partsContainer.appendChild(partDiv);
      });
    }

    // Set subtotal
    setText('subtotalAmount', '$' + subtotal.toFixed(2));
    
    // Handle discount (as percentage)
    const discountPercent = (p.discount != null && p.discount !== '') ? parseFloat(p.discount) : 0;
    let discountAmount = 0;
    let finalTotal = subtotal;
    
    if (discountPercent > 0) {
      discountAmount = (subtotal * discountPercent) / 100;
      finalTotal = subtotal - discountAmount;
      
      const discountSection = document.getElementById('discountSection');
      const discountLabel = discountSection.querySelector('.discount-label');
      discountSection.style.display = 'flex';
      discountLabel.textContent = 'DISCOUNT (' + discountPercent + '%)';
      setText('discountAmount', '-$' + discountAmount.toFixed(2));
    }
    
    // Handle tax (only if stored in project - calculated based on "In Person" store in project management)
    const taxAmount = (p.taxAmount != null && p.taxAmount !== '') ? parseFloat(p.taxAmount) : 0;
    if (taxAmount > 0) {
      finalTotal += taxAmount;
      
      const taxSection = document.getElementById('taxSection');
      
      // Calculate and display tax rate
      const afterDiscount = subtotal - discountAmount;
      const taxRate = afterDiscount > 0 ? (taxAmount / afterDiscount) * 100 : 0;
      
      const taxLabel = document.getElementById('taxLabel');
      taxLabel.textContent = 'TAX (' + taxRate.toFixed(3) + '%)';
      setText('taxAmount', '$' + taxAmount.toFixed(2));
      taxSection.style.display = 'flex';
    }
    
    // Set final total
    setText('totalAmount', '$' + finalTotal.toFixed(2));
  })();
  </script>
</body>
</html>
