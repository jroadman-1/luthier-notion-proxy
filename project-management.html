<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project Management - Luthier</title>
  <style>
    body{
      font-family: Arial, sans-serif;max-width:1400px;margin:0 auto;padding:20px;background:#f5f5f5
    }
    .header{background:#2c3e50;color:#fff;padding:20px;border-radius:8px;text-align:center;margin-bottom:20px}
    .main-container{display:grid;grid-template-columns:300px 1fr;gap:20px;height:calc(100vh - 140px)}
    .projects-list{background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);overflow-y:auto}
    .projects-header{padding:15px;border-bottom:1px solid #eee;font-weight:bold;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:5px}
    .header-buttons{display:flex;gap:5px}
    .project-item{padding:12px 15px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:.2s}
    .project-item:hover{background:#f8f9fa}
    .project-item.active{background:#e3f2fd;border-left:4px solid #2196f3}
    .project-item.new-project{background:#f0f8ff;border-left:4px solid #4caf50;font-style:italic}
    .project-name{font-weight:bold;color:#2c3e50;margin-bottom:4px}
    .project-details{font-size:12px;color:#666}
    .project-editor{background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);display:flex;flex-direction:column}
    .editor-header{padding:20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    .project-id-input{width:200px;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box}
    .editor-content{flex:1;padding:20px;overflow-y:auto}
    .form-section{margin-bottom:30px}
    .form-section h3{margin:0 0 15px;color:#2c3e50}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}
    .form-group{margin-bottom:15px}
    .form-group.full-width{grid-column:1 / -1}
    .form-group label{display:block;font-weight:bold;margin-bottom:5px;color:#333}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box}
    .form-group textarea{height:80px;resize:vertical}
    .tabs{display:flex;border-bottom:2px solid #e9ecef;margin-bottom:20px}
    .tab{padding:12px 24px;cursor:pointer;border:none;background:none;font-size:14px;font-weight:bold;color:#666;border-bottom:2px solid transparent}
    .tab.active{color:#2196f3;border-bottom-color:#2196f3}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .milestone-list{max-height:400px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:10px;background:#fafafa}
    .milestone-row{display:flex;align-items:center;gap:10px;padding:8px;margin-bottom:5px;background:#fff;border-radius:4px;border-left:3px solid #ddd;position:relative}
    .milestone-row.dragging{opacity:.5;z-index:1000}
    .milestone-row.over{outline:2px dashed #2196f3}
    .milestone-row.ready{border-left-color:#4caf50}
    .milestone-row.completed{border-left-color:#2196f3;opacity:.7;background:#f0f8ff}
    .milestone-row.not-started{border-left-color:#bbb}
    .drag-handle{cursor:grab;color:#999;font-size:16px;width:20px;text-align:center;user-select:none;padding:4px}
    .drag-handle:hover{color:#666;background:#f0f0f0;border-radius:3px}
    .drag-handle:active{cursor:grabbing}
    .milestone-order{width:30px;text-align:center;font-weight:bold;color:#666;font-size:12px}
    .milestone-checkbox{width:18px;height:18px;cursor:pointer;margin-right:5px}
    .milestone-name{flex:1}
    .milestone-name input{width:100%;border:none;background:transparent;padding:4px;font-size:14px}
    .milestone-hours{width:80px}
    .milestone-hours input{width:100%;border:none;background:transparent;padding:4px;text-align:center;font-size:14px}
    .milestone-actual-hours{width:80px}
    .milestone-actual-hours input{width:100%;border:none;background:transparent;padding:4px;text-align:center;font-size:12px;color:#666}
    .milestone-status{width:100px}
    .milestone-status select{width:100%;border:none;background:transparent;padding:2px;font-size:12px}
    .milestone-actions{display:flex;gap:5px;width:80px;align-items:center}
    .remove-milestone{background:#ff5252;color:#fff;border:none;border-radius:3px;padding:4px 8px;cursor:pointer;font-size:11px}
    .save-milestone-btn{background:#4caf50;color:#fff;border:none;border-radius:3px;padding:4px 8px;cursor:pointer;font-size:11px}
    .milestone-completion-controls{display:flex;align-items:center;gap:5px}
    .actual-hours-input{width:60px;padding:2px 4px;border:1px solid #ddd;border-radius:3px;font-size:12px}
    .save-milestone-btn{background:#4caf50;color:#fff;border:none;border-radius:3px;padding:3px 8px;cursor:pointer;font-size:11px}
    .btn{background:#2196f3;color:#fff;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;font-size:14px;margin-right:10px;margin-bottom:10px}
    .btn:hover{background:#1976d2}
    .btn.success{background:#4caf50}
    .btn.secondary{background:#6c757d}
    .btn.danger{background:#ff5252}
    .btn.small{padding:5px 10px;font-size:12px}
    .workflow-selector{margin-bottom:15px}
    .workflow-preview{background:#f8f9fa;padding:15px;border-radius:4px;margin-top:10px}
    .auto-split-controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:15px}
    .loading,.empty-state{text-align:center;padding:40px;color:#666}
    .save-indicator{color:#4caf50;font-size:12px;margin-left:10px}
    .error{background:#f8d7da;color:#721c24;padding:10px;border-radius:4px;margin:10px 0}
    .success{background:#d4edda;color:#155724;padding:10px;border-radius:4px;margin:10px 0}
    .new-project-indicator{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:4px;margin-bottom:15px;border-left:4px solid #4caf50}
    .collapsible-section{cursor:pointer}
    .collapsible-section h3{cursor:pointer;display:flex;align-items:center;gap:10px}
    .collapsible-toggle{transition:transform 0.2s}
    .collapsible-content{margin-top:15px}
    .time-summary{background:#e8f5e8;padding:15px;border-radius:6px;margin-bottom:20px;border-left:4px solid #4caf50}
    .time-summary h4{margin:0 0 10px;color:#2e7d32}
    .time-summary .time-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
    .time-stat{text-align:center;padding:8px;background:rgba(255,255,255,0.7);border-radius:4px}
    .time-stat .value{font-size:18px;font-weight:bold;color:#2e7d32}
    .time-stat .label{font-size:12px;color:#666;margin-top:2px}
    .checkbox-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:15px}
    .checkbox-item{display:flex;align-items:center;gap:6px;font-size:14px}
    .checkbox-item input[type="checkbox"]{margin:0}
    .billing-summary{background:#e8f2ff;padding:15px;border-radius:6px;margin-bottom:20px;border-left:4px solid #2196f3}
    .billing-summary h4{margin:0 0 10px;color:#1976d2}
    .billing-stat .label{font-size:12px;color:#666;margin-top:2px}
    .readonly-display{background:#f8f9fa;color:#666;font-weight:bold;text-align:center;padding:8px 12px;border:1px solid #e9ecef;border-radius:4px;margin-top:5px}
  </style>
</head>
<body>
  <div class="header">
    <h1>🎸 Project Management</h1>
    <p>Manage projects and milestones</p>
  </div>

  <div class="main-container">
    <!-- Projects List -->
    <div class="projects-list">
      <div class="projects-header">
        Projects
        <div class="header-buttons">
          <button class="btn small success" onclick="createNewProject()">New</button>
          <button class="btn small" onclick="refreshProjects()">Refresh</button>
        </div>
      </div>
      <div id="projectsList">
        <div class="loading">Loading projects...</div>
      </div>
    </div>

    <!-- Project Editor -->
    <div class="project-editor">
      <div class="editor-header">
        <div>
          <h2 id="editorTitle">Select a project</h2>
          <input type="text" id="projectIdInput" class="project-id-input" placeholder="Project ID" style="display:none;" onchange="markChanged()">
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
  <button class="btn success" onclick="saveProject()" id="saveBtn" disabled>Save Changes</button>
  <button class="btn" onclick="openReportForCurrent()">Open Report</button>
  <button class="btn secondary" onclick="cancelChanges()">Cancel</button>
</div>
      </div>

      <div class="editor-content" id="editorContent">
        <div class="empty-state">
          <h3>Select a project to edit</h3>
          <p>Click on a project from the list to view and edit its details and milestones, or create a new project.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration - Update this to match your Vercel deployment
    const API_URL = '/api/notion-proxy';

    let allProjects = [];
    let allMilestones = [];
    let allWorkflows = [];
    let currentProject = null;
    let currentMilestones = [];
    let hasUnsavedChanges = false;
    let isNewProject = false;

    // Initialize
    window.onload = function () {
      refreshProjects();
    };

    async function refreshProjects() {
      try {
        showMessage('Loading projects...', 'info');

        const [dataResponse, workflowsResponse] = await Promise.all([
          fetch(API_URL),
          fetch(`${API_URL}?action=workflows`)
        ]);

        if (!dataResponse.ok) {
          const errorText = await dataResponse.text();
          throw new Error(`Data API failed with ${dataResponse.status}: ${errorText}`);
        }

        const data = await dataResponse.json();

        let workflows = { workflows: [] };
        if (workflowsResponse.ok) {
          workflows = await workflowsResponse.json();
        } else {
          const errorText = await workflowsResponse.text();
          console.warn('Workflows API failed:', workflowsResponse.status, errorText);
          showMessage('Workflows could not be loaded, continuing without them', 'info');
        }

        allProjects = data.projects || [];
        allMilestones = data.milestones || [];
        allWorkflows = workflows.workflows || [];

        displayProjectsList();
        showMessage(`Loaded ${allProjects.length} projects, ${allMilestones.length} milestones, ${allWorkflows.length} workflows`, 'success');
      } catch (error) {
        console.error('Failed to refresh projects:', error);
        const errorMsg = `Failed to load projects: ${error.message}`;
        document.getElementById('projectsList').innerHTML =
          `<div class="error">${errorMsg}<br><br>Check the browser console for details.</div>`;
        showMessage(errorMsg, 'error');
      }
    }

    function createNewProject() {
      if (hasUnsavedChanges && !confirm('You have unsaved changes. Continue anyway?')) return;

      currentProject = {
        id: null,
        name: 'New Project',
        projectId: '',
        instrumentMake: '',
        instrumentModel: '',
        status: 'On The Bench',
        complexity: 3,
        profitability: 3,
        dueDate: null,
        intakeNotes: '',
        store: '',
        totalEstimatedHour: 0,
        totalMilestones: 0,
        completedMilestones: 0,
        progress: 0,
        // Initialize billing fields
        total: null,
        commission: null,
        minusCommission: null,
        // Initialize measurement fields
        neckReliefBefore: null,
        before1stString1stFret: null,
        before1stString12thFret: null,
        before6thString1stFret: null,
        before6thString12thFret: null,
        neckReliefAfter: null,
        after1stString1stFret: null,
        after1stString12thFret: null,
        after6thString1stFret: null,
        after6thString12thFret: null,
        // Initialize instrument details
        instrumentFinish: '',
        serialNumber: '',
        instrumentType: '',
        stringBrand: '',
        stringGauge: '',
        tuning: '',
        tremolo: '',
        fretboardRadius: null,
        fretwire: '',
        // Initialize actions
        actions: {},
        additionalActions: '',
        notes: ''
      };

      currentMilestones = [];
      isNewProject = true;
      hasUnsavedChanges = true;

      displayProjectEditor();
      displayProjectsList();
      updateSaveButton();
    }

    function showMessage(message, type = 'info') {
      let msgEl = document.getElementById('globalMessage');
      if (!msgEl) {
        msgEl = document.createElement('div');
        msgEl.id = 'globalMessage';
        msgEl.style.cssText = 'position: fixed; top: 10px; right: 10px; padding: 10px; border-radius: 4px; z-index: 1000; max-width: 300px;';
        document.body.appendChild(msgEl);
      }
      msgEl.textContent = message;
      msgEl.className = type;

      if (type === 'success') {
        setTimeout(() => {
          if (msgEl.parentNode) msgEl.parentNode.removeChild(msgEl);
        }, 3000);
      }
    }

    function displayProjectsList() {
      const container = document.getElementById('projectsList');
      let html = '';

      if (isNewProject && currentProject) {
        html += `
          <div class="project-item new-project active">
            <div class="project-name">${escapeHtml(currentProject.name)} (New)</div>
            <div class="project-details">Unsaved new project</div>
          </div>
        `;
      }

      if (allProjects.length === 0 && !isNewProject) {
        container.innerHTML = '<div class="empty-state">No projects found</div>';
        return;
      }

      allProjects.forEach(project => {
        const isActive = !isNewProject && currentProject && currentProject.id === project.id;
        html += `
          <div class="project-item ${isActive ? 'active' : ''}" onclick="selectProject('${project.id}')">
            <div class="project-name">${escapeHtml(project.name)}</div>
            <div class="project-details">
              ${escapeHtml(project.instrumentMake)} ${escapeHtml(project.instrumentModel)} • 
              ${project.totalMilestones || 0} milestones
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function selectProject(projectId) {
      if (hasUnsavedChanges && !confirm('You have unsaved changes. Continue anyway?')) return;

      currentProject = allProjects.find(p => p.id === projectId);
      if (!currentProject) {
        showMessage('Project not found', 'error');
        return;
      }

      isNewProject = false;
      loadProjectMilestones(projectId);

      displayProjectEditor();
      displayProjectsList();

      hasUnsavedChanges = false;
      updateSaveButton();
    }

    function loadProjectMilestones(projectId) {
      currentMilestones = allMilestones
        .filter(m => m.projectId === projectId)
        .sort((a, b) => a.order - b.order);
    }

    function calculateTotalActualHours() {
      return currentMilestones
        .filter(m => m.status === 'Completed' && m.actualHours)
        .reduce((total, m) => total + (m.actualHours || 0), 0);
    }

    function calculateEstimatedHours() {
      return currentMilestones.reduce((total, m) => total + (m.estimatedHours || 0), 0);
    }

    function calculateMinusCommission() {
      const total = parseFloat(document.getElementById('total')?.value) || 0;
      const commission = parseFloat(document.getElementById('commission')?.value) || 0;
      return total - commission;
    }

    function updateBillingCalculation() {
      const minusCommissionDisplay = document.getElementById('minusCommissionDisplay');
      if (minusCommissionDisplay) {
        const result = calculateMinusCommission();
        minusCommissionDisplay.textContent = `${result.toFixed(2)}`;
      }
    }

    function displayProjectEditor() {
      if (!currentProject) return;

      document.getElementById('editorTitle').textContent = isNewProject ? 'New Project' : currentProject.name;
      
      // Show/hide project ID input
      const projectIdInput = document.getElementById('projectIdInput');
      if (isNewProject || currentProject) {
        projectIdInput.style.display = 'block';
        projectIdInput.value = currentProject.projectId || '';
      } else {
        projectIdInput.style.display = 'none';
      }

      let content = '';
      if (isNewProject) {
        content += `
          <div class="new-project-indicator">
            <strong>Creating New Project</strong><br>
            Fill in the details below and click "Save Changes" to create this project in Notion.
          </div>
        `;
      }

      // Time summary for existing projects
      if (!isNewProject && currentMilestones.length > 0) {
        const totalActual = calculateTotalActualHours();
        const totalEstimated = calculateEstimatedHours();
        const completedCount = currentMilestones.filter(m => m.status === 'Completed').length;
        const totalCount = currentMilestones.length;
        
        content += `
          <div class="time-summary">
            <h4>Project Time Summary</h4>
            <div class="time-stats">
              <div class="time-stat">
                <div class="value">${totalActual.toFixed(1)}h</div>
                <div class="label">Total Actual Time</div>
              </div>
              <div class="time-stat">
                <div class="value">${totalEstimated.toFixed(1)}h</div>
                <div class="label">Total Estimated</div>
              </div>
              <div class="time-stat">
                <div class="value">${completedCount}/${totalCount}</div>
                <div class="label">Completed Milestones</div>
              </div>
              <div class="time-stat">
                <div class="value">${totalCount > 0 ? Math.round((completedCount/totalCount)*100) : 0}%</div>
                <div class="label">Progress</div>
              </div>
            </div>
          </div>
        `;
      }

      // Billing summary for existing projects with billing data
      if (!isNewProject && (currentProject.total || currentProject.commission)) {
        const total = currentProject.total || 0;
        const commission = currentProject.commission || 0;
        const minusCommission = currentProject.minusCommission || (total - commission);
        
        content += `
          <div class="billing-summary">
            <h4>Project Billing Summary</h4>
            <div class="billing-stats">
              <div class="billing-stat">
                <div class="value">${total.toFixed(2)}</div>
                <div class="label">Total Amount</div>
              </div>
              <div class="billing-stat">
                <div class="value">${commission.toFixed(2)}</div>
                <div class="label">Commission</div>
              </div>
              <div class="billing-stat">
                <div class="value">${minusCommission.toFixed(2)}</div>
                <div class="label">Minus Commission</div>
              </div>
            </div>
          </div>
        `;
      }

      content += `
        <div class="form-section">
          <h3>Project Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Project Name</label>
              <input type="text" id="projectName" value="${escapeHtml(currentProject.name || '')}" onchange="markChanged()">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="projectStatus" onchange="markChanged()">
                <option value="On The Bench" ${currentProject.status === 'On The Bench' ? 'selected' : ''}>On The Bench</option>
                <option value="Waiting" ${currentProject.status === 'Waiting' ? 'selected' : ''}>Waiting</option>
                <option value="Done" ${currentProject.status === 'Done' ? 'selected' : ''}>Done</option>
              </select>
            </div>
            <div class="form-group">
              <label>Instrument Make</label>
              <input type="text" id="instrumentMake" value="${escapeHtml(currentProject.instrumentMake || '')}" onchange="markChanged()">
            </div>
            <div class="form-group">
              <label>Instrument Model</label>
              <input type="text" id="instrumentModel" value="${escapeHtml(currentProject.instrumentModel || '')}" onchange="markChanged()">
            </div>
            <div class="form-group">
              <label>Complexity (1-5)</label>
              <select id="complexity" onchange="markChanged()">
                ${[1,2,3,4,5].map(n => `<option value="${n}" ${(currentProject.complexity || 3) === n ? 'selected' : ''}>${n} - ${['Simple','Easy','Moderate','Complex','Very Complex'][n-1]}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Profitability (1-5)</label>
              <select id="profitability" onchange="markChanged()">
                ${[1,2,3,4,5].map(n => `<option value="${n}" ${(currentProject.profitability || 3) === n ? 'selected' : ''}>${n} - ${['Low','Below Average','Standard','Good','Excellent'][n-1]}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Due Date</label>
              <input type="date" id="dueDate" value="${currentProject.dueDate || ''}" onchange="markChanged()">
            </div>
            <div class="form-group">
              <label>Store</label>
              <select id="store" onchange="markChanged()">
                <option value="">Select Store</option>
                <option value="In Person"        ${currentProject.store === 'In Person' ? 'selected' : ''}>In Person</option>
                <option value="Spacetone"        ${currentProject.store === 'Spacetone' ? 'selected' : ''}>Spacetone</option>
                <option value="Lark Guitars"     ${currentProject.store === 'Lark Guitars' ? 'selected' : ''}>Lark Guitars</option>
                <option value="Robot Monster"    ${currentProject.store === 'Robot Monster' ? 'selected' : ''}>Robot Monster</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label>Intake Notes</label>
              <textarea id="intakeNotes" onchange="markChanged()" placeholder="Enter any initial notes, requirements, or special instructions for this project...">${escapeHtml(currentProject.intakeNotes || '')}</textarea>
            </div>
          </div>
        </div>

        

        <div class="form-section collapsible-section">
          <h3 onclick="toggleCollapsible('measurements')">
            <span id="measurementsToggle" class="collapsible-toggle">▶</span>
            Measurements (Before/After)
          </h3>
          <div id="measurementsContent" class="collapsible-content" style="display: none;">
            <div class="form-grid">
              <div class="form-group full-width">
                <h4 style="margin: 0 0 15px 0; color: #666; font-size: 14px;">Before Measurements</h4>
              </div>
              <div class="form-group full-width">
                <label>Neck Relief Before</label>
                <input type="number" step="0.001" id="neckReliefBefore" 
                       value="${currentProject.neckReliefBefore || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
              <div class="form-group">
                <label>1st String at 1st Fret</label>
                <input type="number" step="0.001" id="before1stString1stFret" 
                       value="${currentProject.before1stString1stFret || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
              <div class="form-group">
                <label>1st String at 12th Fret</label>
                <input type="number" step="0.001" id="before1stString12thFret" 
                       value="${currentProject.before1stString12thFret || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
              <div class="form-group">
                <label>6th String at 1st Fret</label>
                <input type="number" step="0.001" id="before6thString1stFret" 
                       value="${currentProject.before6thString1stFret || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
              <div class="form-group">
                <label>6th String at 12th Fret</label>
                <input type="number" step="0.001" id="before6thString12thFret" 
                       value="${currentProject.before6thString12thFret || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
              
              <div class="form-group full-width">
                <h4 style="margin: 20px 0 15px 0; color: #666; font-size: 14px;">After Measurements</h4>
              </div>
              <div class="form-group full-width">
                <label>Neck Relief After</label>
                <input type="number" step="0.001" id="neckReliefAfter" 
                       value="${currentProject.neckReliefAfter || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
              <div class="form-group">
                <label>1st String at 1st Fret</label>
                <input type="number" step="0.001" id="after1stString1stFret" 
                       value="${currentProject.after1stString1stFret || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
              <div class="form-group">
                <label>1st String at 12th Fret</label>
                <input type="number" step="0.001" id="after1stString12thFret" 
                       value="${currentProject.after1stString12thFret || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
              <div class="form-group">
                <label>6th String at 1st Fret</label>
                <input type="number" step="0.001" id="after6thString1stFret" 
                       value="${currentProject.after6thString1stFret || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
              <div class="form-group">
                <label>6th String at 12th Fret</label>
                <input type="number" step="0.001" id="after6thString12thFret" 
                       value="${currentProject.after6thString12thFret || ''}" 
                       onchange="markChanged()" placeholder="0.000">
              </div>
            </div>
          </div>
        </div>

        <div class="form-section collapsible-section">
          <h3 onclick="toggleCollapsible('instrumentDetails')">
            <span id="instrumentDetailsToggle" class="collapsible-toggle">▶</span>
            Instrument Details
          </h3>
          <div id="instrumentDetailsContent" class="collapsible-content" style="display: none;">
            <div class="form-grid">
              <div class="form-group">
                <label>Instrument Finish/Color</label>
                <input type="text" id="instrumentFinish" value="${escapeHtml(currentProject.instrumentFinish || '')}" onchange="markChanged()">
              </div>
              <div class="form-group">
                <label>Serial Number</label>
                <input type="text" id="serialNumber" value="${escapeHtml(currentProject.serialNumber || '')}" onchange="markChanged()">
              </div>
              <div class="form-group">
                <label>Instrument Type</label>
                <select id="instrumentType" onchange="markChanged()">
                  <option value="">Select Type</option>
                  <option value="Guitar" ${currentProject.instrumentType === 'Guitar' ? 'selected' : ''}>Guitar</option>
                  <option value="Banjo" ${currentProject.instrumentType === 'Banjo' ? 'selected' : ''}>Banjo</option>
                  <option value="Bass" ${currentProject.instrumentType === 'Bass' ? 'selected' : ''}>Bass</option>
                  <option value="Mandolin" ${currentProject.instrumentType === 'Mandolin' ? 'selected' : ''}>Mandolin</option>
                  <option value="12 string guitar" ${currentProject.instrumentType === '12 string guitar' ? 'selected' : ''}>12 string guitar</option>
                  <option value="Pickup" ${currentProject.instrumentType === 'Pickup' ? 'selected' : ''}>Pickup</option>
                  <option value="Classical Guitar" ${currentProject.instrumentType === 'Classical Guitar' ? 'selected' : ''}>Classical Guitar</option>
                </select>
              </div>
              <div class="form-group">
                <label>String Brand</label>
                <input type="text" id="stringBrand" value="${escapeHtml(currentProject.stringBrand || '')}" onchange="markChanged()">
              </div>
              <div class="form-group">
                <label>String Gauge</label>
                <input type="text" id="stringGauge" value="${escapeHtml(currentProject.stringGauge || '')}" onchange="markChanged()">
              </div>
              <div class="form-group">
                <label>Tuning</label>
                <select id="tuning" onchange="markChanged()">
                  <option value="">Select Tuning</option>
                  <option value="Standard" ${currentProject.tuning === 'Standard' ? 'selected' : ''}>Standard</option>
                  <option value="Drop D" ${currentProject.tuning === 'Drop D' ? 'selected' : ''}>Drop D</option>
                  <option value="Drop C" ${currentProject.tuning === 'Drop C' ? 'selected' : ''}>Drop C</option>
                  <option value="Half Step Down" ${currentProject.tuning === 'Half Step Down' ? 'selected' : ''}>Half Step Down</option>
                  <option value="Whole Step Down" ${currentProject.tuning === 'Whole Step Down' ? 'selected' : ''}>Whole Step Down</option>
                  <option value="Open G" ${currentProject.tuning === 'Open G' ? 'selected' : ''}>Open G</option>
                  <option value="Open D" ${currentProject.tuning === 'Open D' ? 'selected' : ''}>Open D</option>
                  <option value="DADGAD" ${currentProject.tuning === 'DADGAD' ? 'selected' : ''}>DADGAD</option>
                  <option value="Custom" ${currentProject.tuning === 'Custom' ? 'selected' : ''}>Custom</option>
                </select>
              </div>
              <div class="form-group">
                <label>Tremolo</label>
                <input type="text" id="tremolo" value="${escapeHtml(currentProject.tremolo || '')}" onchange="markChanged()">
              </div>
              <div class="form-group">
                <label>Fretboard Radius</label>
                <input type="number" step="0.1" id="fretboardRadius" value="${currentProject.fretboardRadius || ''}" onchange="markChanged()">
              </div>
              <div class="form-group full-width">
                <label>Fretwire</label>
                <input type="text" id="fretwire" value="${escapeHtml(currentProject.fretwire || '')}" onchange="markChanged()">
              </div>
            </div>
          </div>
        </div>

        <div class="form-section collapsible-section">
          <h3 onclick="toggleCollapsible('actions')">
            <span id="actionsToggle" class="collapsible-toggle">▶</span>
            Actions
          </h3>
          <div id="actionsContent" class="collapsible-content" style="display: none;">
            <div class="checkbox-grid">
              <div class="checkbox-item">
                <input type="checkbox" id="adjustedHeightRadius" onchange="markChanged()" ${currentProject.actions?.adjustedHeightRadius ? 'checked' : ''}>
                <label for="adjustedHeightRadius">Adjusted Height and Radius</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="adjustedIntonation" onchange="markChanged()" ${currentProject.actions?.adjustedIntonation ? 'checked' : ''}>
                <label for="adjustedIntonation">Adjusted Intonation</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="adjustedPickupHeight" onchange="markChanged()" ${currentProject.actions?.adjustedPickupHeight ? 'checked' : ''}>
                <label for="adjustedPickupHeight">Adjusted Pickup Height</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="adjustedTrussRod" onchange="markChanged()" ${currentProject.actions?.adjustedTrussRod ? 'checked' : ''}>
                <label for="adjustedTrussRod">Adjusted Truss Rod</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="adjustedStringSlots" onchange="markChanged()" ${currentProject.actions?.adjustedStringSlots ? 'checked' : ''}>
                <label for="adjustedStringSlots">Adjusted String Slots</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="cleanedPolished" onchange="markChanged()" ${currentProject.actions?.cleanedPolished ? 'checked' : ''}>
                <label for="cleanedPolished">Cleaned and Polished</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="installedStretchedStrings" onchange="markChanged()" ${currentProject.actions?.installedStretchedStrings ? 'checked' : ''}>
                <label for="installedStretchedStrings">Installed and Stretched Strings</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="lubricatedStringSlots" onchange="markChanged()" ${currentProject.actions?.lubricatedStringSlots ? 'checked' : ''}>
                <label for="lubricatedStringSlots">Lubricated String Slots</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="oiledFretboard" onchange="markChanged()" ${currentProject.actions?.oiledFretboard ? 'checked' : ''}>
                <label for="oiledFretboard">Oiled Fretboard</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="polishedFrets" onchange="markChanged()" ${currentProject.actions?.polishedFrets ? 'checked' : ''}>
                <label for="polishedFrets">Polished Frets</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="testedElectronics" onchange="markChanged()" ${currentProject.actions?.testedElectronics ? 'checked' : ''}>
                <label for="testedElectronics">Tested Electronics</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="tightenedHardware" onchange="markChanged()" ${currentProject.actions?.tightenedHardware ? 'checked' : ''}>
                <label for="tightenedHardware">Tightened Hardware</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="adjustedTremoloTension" onchange="markChanged()" ${currentProject.actions?.adjustedTremoloTension ? 'checked' : ''}>
                <label for="adjustedTremoloTension">Adjusted Tremolo Tension</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="adjustedNeckAngle" onchange="markChanged()" ${currentProject.actions?.adjustedNeckAngle ? 'checked' : ''}>
                <label for="adjustedNeckAngle">Adjusted Neck Angle</label>
              </div>
            </div>
            
            <div class="form-group" style="margin-top:15px;">
              <label>Additional Actions</label>
              <textarea id="additionalActions" onchange="markChanged()" placeholder="Enter any additional actions performed...">${escapeHtml(currentProject.additionalActions || '')}</textarea>
            </div>
            
          <div class="form-group" style="margin-top:15px;">
          <label>Notes</label>
            <textarea id="notes" onchange="markChanged()" placeholder="General project notes, updates, or reminders...">${escapeHtml(currentProject.notes || '')}</textarea>
</div>

</div>
       
        </div>

        

        <div class="form-section collapsible-section">
          <h3 onclick="toggleCollapsible('billing')">
            <span id="billingToggle" class="collapsible-toggle">▶</span>
            Billing
          </h3>
          <div id="billingContent" class="collapsible-content" style="display: none;">
            <div class="form-grid">
              <div class="form-group">
                <label>Total Amount ($)</label>
                <input type="number" step="0.01" min="0" id="total" 
                       value="${currentProject.total || ''}" 
                       onchange="markChanged(); updateBillingCalculation()" 
                       placeholder="0.00">
              </div>
              <div class="form-group">
                <label>Commission ($)</label>
                <input type="number" step="0.01" min="0" id="commission" 
                       value="${currentProject.commission || ''}" 
                       onchange="markChanged(); updateBillingCalculation()" 
                       placeholder="0.00">
              </div>
              <div class="form-group full-width">
                <label>Minus Commission (Calculated)</label>
                <div class="readonly-display" id="minusCommissionDisplay">
                  ${((currentProject.total || 0) - (currentProject.commission || 0)).toFixed(2)}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Milestones</h3>
          <div class="tabs">
            <button class="tab active" onclick="switchMilestoneTab('individual')">Individual Entry</button>
            <button class="tab" onclick="switchMilestoneTab('workflow')">Workflow Templates</button>
            <button class="tab" onclick="switchMilestoneTab('autosplit')">Auto-Split Time</button>
          </div>

          <div class="tab-content active" id="individual-tab">
            <div class="milestone-list" id="milestoneList">
              ${renderMilestoneList()}
            </div>
            <button class="btn" onclick="addMilestone()">Add Milestone</button>
            <button class="btn secondary" onclick="addMultipleMilestones()">Add 5 More</button>
            ${!isNewProject && currentMilestones.some(m => m.status === 'Completed' && !m.actualHours) ? 
              '<button class="btn success" onclick="saveAllCompletedMilestones()" style="margin-top:10px;">Save All Completed Milestones</button>' : 
              ''}
          </div>

          <div class="tab-content" id="workflow-tab">
            <div class="workflow-selector">
              <label>Select Workflow Template:</label>
              <select id="workflowSelect" onchange="previewWorkflow()">
                <option value="">Choose a workflow...</option>
                ${allWorkflows.map(w => `<option value="${w.id}">${escapeHtml(w.name)}</option>`).join('')}
              </select>
            </div>
            <div id="workflowPreview"></div>
            <button class="btn" onclick="applyWorkflow()">Apply Workflow</button>
          </div>

          <div class="tab-content" id="autosplit-tab">
            <div class="auto-split-controls">
              <div class="form-group">
                <label>Total Hours</label>
                <input type="number" id="splitTotalHours" step="0.25" min="0.25" value="4" onchange="previewAutoSplit()">
              </div>
              <div class="form-group">
                <label>Number of Sessions</label>
                <input type="number" id="splitSessions" min="2" max="10" value="4" onchange="previewAutoSplit()">
              </div>
              <div class="form-group">
                <label>Base Name</label>
                <input type="text" id="splitBaseName" value="Work Session" onchange="previewAutoSplit()">
              </div>
            </div>
            <div id="autoSplitPreview"></div>
            <button class="btn" onclick="applyAutoSplit()">Apply Auto-Split</button>
          </div>
        </div>
      `;

      document.getElementById('editorContent').innerHTML = content;

      // Make sure DnD is active on FIRST render
      setupDragAndDrop();

      // Initialize auto-split preview
      previewAutoSplit();
      
      // Initialize billing calculation
      updateBillingCalculation();
    }

    function toggleCollapsible(section) {
      const content = document.getElementById(`${section}Content`);
      const toggle = document.getElementById(`${section}Toggle`);
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '▼';
      } else {
        content.style.display = 'none';
        toggle.textContent = '▶';
      }
    }

    function renderMilestoneList() {
      if (currentMilestones.length === 0) {
        return '<div class="empty-state">No milestones yet. Add some below.</div>';
      }

      return currentMilestones.map((milestone, index) => `
        <div class="milestone-row ${(milestone.status || 'Not Started').toLowerCase().replace(' ', '-')}"
             draggable="true"
             data-milestone-index="${index}">
          <div class="drag-handle" title="Drag to reorder">⋮⋮</div>
          <div class="milestone-order">${index + 1}</div>
          <input type="checkbox" class="milestone-checkbox" 
                 ${milestone.status === 'Completed' ? 'checked' : ''}
                 onchange="toggleMilestoneCompletion(${index})"
                 id="milestone-checkbox-${index}">
          <div class="milestone-name">
            <input type="text" value="${escapeHtml(milestone.name || '')}"
                   onchange="updateMilestone(${index}, 'name', this.value)"
                   placeholder="Milestone name">
          </div>
          <div class="milestone-hours">
            <input type="number" step="0.25" min="0.25"
                   value="${milestone.estimatedHours || 1}"
                   onchange="updateMilestone(${index}, 'estimatedHours', this.value)"
                   title="Estimated Hours"
                   placeholder="Est">
          </div>
          <div class="milestone-actual-hours">
            <input type="number" step="0.25" min="0.25"
                   value="${milestone.status === 'Completed' ? (milestone.actualHours || '') : ''}"
                   onchange="updateMilestone(${index}, 'actualHours', this.value)"
                   placeholder="Actual"
                   title="Actual Hours"
                   ${milestone.status !== 'Completed' ? 'disabled' : ''}
                   id="actual-hours-${index}"
                   style="${milestone.status !== 'Completed' ? 'background:#f5f5f5;color:#ccc;' : ''}">
          </div>
          <div class="milestone-status">
            <select onchange="updateMilestone(${index}, 'status', this.value)">
              <option value="Not Started" ${milestone.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
              <option value="Ready" ${milestone.status === 'Ready' ? 'selected' : ''}>Ready</option>
              <option value="Completed" ${milestone.status === 'Completed' ? 'selected' : ''}>Completed</option>
            </select>
          </div>
          <div class="milestone-actions">
            ${milestone.status === 'Completed' && milestone.actualHours && milestone.id ? 
              `<button class="save-milestone-btn" onclick="saveSingleMilestone(${index})" title="Save to Notion">Save</button>` : 
              ''
            }
            <button class="remove-milestone" onclick="removeMilestone(${index})" title="Remove milestone">×</button>
          </div>
        </div>
      `).join('');
    }

    function toggleMilestoneCompletion(index) {
      const checkbox = document.getElementById(`milestone-checkbox-${index}`);
      const milestone = currentMilestones[index];
      
      if (checkbox.checked) {
        milestone.status = 'Completed';
        // Pre-fill actual hours with estimated hours if not already set
        if (!milestone.actualHours) {
          milestone.actualHours = milestone.estimatedHours || 1;
        }
      } else {
        milestone.status = 'Not Started';
        // Clear actual hours when unchecking
        milestone.actualHours = null;
      }
      
      refreshMilestoneList();
      markChanged();
      
      // Focus on actual hours input if just completed
      if (checkbox.checked) {
        setTimeout(() => {
          const actualInput = document.getElementById(`actual-hours-${index}`);
          if (actualInput) {
            actualInput.focus();
            actualInput.select();
          }
        }, 100);
      }
    }

    async function saveSingleMilestone(index) {
      const milestone = currentMilestones[index];
      if (!milestone.actualHours || milestone.actualHours <= 0) {
        alert('Please enter actual hours before saving.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}?action=save-progress`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            completedMilestones: [{
              milestoneId: milestone.id,
              projectId: currentProject.id,
              actualHours: milestone.actualHours
            }]
          })
        });

        if (!response.ok) {
          throw new Error(`Failed to save milestone progress: ${response.statusText}`);
        }

        showMessage('Milestone progress saved successfully', 'success');
        refreshMilestoneList();
      } catch (error) {
        console.error('Failed to save milestone:', error);
        showMessage('Failed to save milestone progress: ' + error.message, 'error');
      }
    }

    async function saveAllCompletedMilestones() {
      const completedWithHours = currentMilestones.filter(m => 
        m.status === 'Completed' && m.actualHours && m.actualHours > 0 && m.id
      );

      if (completedWithHours.length === 0) {
        alert('No completed milestones with actual hours found to save.');
        return;
      }

      try {
        const completedMilestones = completedWithHours.map(m => ({
          milestoneId: m.id,
          projectId: currentProject.id,
          actualHours: m.actualHours
        }));

        const response = await fetch(`${API_URL}?action=save-progress`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completedMilestones })
        });

        if (!response.ok) {
          throw new Error(`Failed to save progress: ${response.statusText}`);
        }

        showMessage(`Saved progress for ${completedMilestones.length} milestones`, 'success');
        refreshMilestoneList();
      } catch (error) {
        console.error('Failed to save all milestones:', error);
        showMessage('Failed to save milestone progress: ' + error.message, 'error');
      }
    }

    function switchMilestoneTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`[onclick="switchMilestoneTab('${tabName}')"]`).classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    function addMilestone() {
      const newMilestone = {
        id: null,
        name: `New Milestone ${currentMilestones.length + 1}`,
        estimatedHours: 1,
        actualHours: 0,
        order: currentMilestones.length + 1,
        status: 'Not Started'
      };
      currentMilestones.push(newMilestone);
      refreshMilestoneList();
      markChanged();
    }

    function addMultipleMilestones() {
      const start = currentMilestones.length;
      for (let i = 0; i < 5; i++) {
        currentMilestones.push({
          id: null,
          name: `New Milestone ${start + i + 1}`,
          estimatedHours: 1,
          actualHours: 0,
          order: start + i + 1,
          status: 'Not Started'
        });
      }
      refreshMilestoneList();
      markChanged();
    }

    function removeMilestone(index) {
      currentMilestones.splice(index, 1);
      currentMilestones.forEach((m, i) => m.order = i + 1);
      refreshMilestoneList();
      markChanged();
    }

    function updateMilestone(index, field, value) {
      if (field === 'estimatedHours' || field === 'actualHours') {
        value = parseFloat(value) || (field === 'estimatedHours' ? 1 : 0);
      }
      currentMilestones[index][field] = value;
      
      // If status changed to completed and no actual hours, set to estimated
      if (field === 'status' && value === 'Completed' && !currentMilestones[index].actualHours) {
        currentMilestones[index].actualHours = currentMilestones[index].estimatedHours || 1;
      }
      
      refreshMilestoneList();
      markChanged();
    }

    function refreshMilestoneList() {
      const container = document.getElementById('milestoneList');
      if (container) {
        container.innerHTML = renderMilestoneList();
        setupDragAndDrop();
        
        // Update time summary if it exists
        const timeSummary = document.querySelector('.time-summary');
        if (timeSummary && !isNewProject) {
          const totalActual = calculateTotalActualHours();
          const totalEstimated = calculateEstimatedHours();
          const completedCount = currentMilestones.filter(m => m.status === 'Completed').length;
          const totalCount = currentMilestones.length;
          
          timeSummary.querySelector('.time-stats').innerHTML = `
            <div class="time-stat">
              <div class="value">${totalActual.toFixed(1)}h</div>
              <div class="label">Total Actual Time</div>
            </div>
            <div class="time-stat">
              <div class="value">${totalEstimated.toFixed(1)}h</div>
              <div class="label">Total Estimated</div>
            </div>
            <div class="time-stat">
              <div class="value">${completedCount}/${totalCount}</div>
              <div class="label">Completed Milestones</div>
            </div>
            <div class="time-stat">
              <div class="value">${totalCount > 0 ? Math.round((completedCount/totalCount)*100) : 0}%</div>
              <div class="label">Progress</div>
            </div>
          `;
        }
      }
    }

    // ========= Drag & Drop Handlers =========
    let dragSrcIndex = null;

    function handleDragStart(e) {
      dragSrcIndex = parseInt(this.dataset.milestoneIndex, 10);
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', String(dragSrcIndex));
    }

    function handleDragOver(e) {
      e.preventDefault(); // allow drop
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter() {
      this.classList.add('over');
    }

    function handleDragLeave() {
      this.classList.remove('over');
    }

    function handleDrop(e) {
      e.preventDefault();
      this.classList.remove('over');

      const from = dragSrcIndex ?? parseInt(e.dataTransfer.getData('text/plain'), 10);
      const to = parseInt(this.dataset.milestoneIndex, 10);

      if (Number.isNaN(from) || Number.isNaN(to) || from === to) return;

      const [moved] = currentMilestones.splice(from, 1);
      currentMilestones.splice(to, 0, moved);
      currentMilestones.forEach((m, i) => (m.order = i + 1));

      refreshMilestoneList();
      markChanged();
    }

    function handleDragEnd() {
      this.classList.remove('dragging');
      dragSrcIndex = null;
      document.querySelectorAll('.milestone-row').forEach(el => el.classList.remove('over'));
    }

    function setupDragAndDrop() {
      const rows = document.querySelectorAll('.milestone-row[draggable="true"]');
      rows.forEach(row => {
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragenter', handleDragEnter);
        row.addEventListener('dragleave', handleDragLeave);
      });
    }

    function previewWorkflow() {
      const workflowId = document.getElementById('workflowSelect').value;
      const preview = document.getElementById('workflowPreview');
      if (!workflowId) { preview.innerHTML = ''; return; }

      const workflow = allWorkflows.find(w => w.id === workflowId);
      if (!workflow) return;

      try {
        const milestones = JSON.parse(workflow.data);
        let html = '<div class="workflow-preview"><h4>Preview:</h4>';
        milestones.forEach((ms, i) => {
          html += `
            <div class="milestone-row">
              <div class="milestone-order">${i + 1}</div>
              <div class="milestone-name">${escapeHtml(ms.name)}</div>
              <div class="milestone-hours">${ms.hours || ms.estimatedHours}h</div>
            </div>
          `;
        });
        html += '</div>';
        preview.innerHTML = html;
      } catch {
        preview.innerHTML = '<div class="error">Invalid workflow data</div>';
      }
    }

    function applyWorkflow() {
      const workflowId = document.getElementById('workflowSelect').value;
      if (!workflowId) return;
      const workflow = allWorkflows.find(w => w.id === workflowId);
      if (!workflow) return;

      try {
        const template = JSON.parse(workflow.data);
        currentMilestones = template.map((ms, i) => ({
          id: null,
          name: ms.name,
          estimatedHours: ms.hours || ms.estimatedHours || 1,
          actualHours: 0,
          order: i + 1,
          status: i === 0 ? 'Ready' : 'Not Started'
        }));
        refreshMilestoneList();
        switchMilestoneTab('individual');
        markChanged();
      } catch {
        showMessage('Invalid workflow data', 'error');
      }
    }

    function previewAutoSplit() {
      const totalHours = parseFloat(document.getElementById('splitTotalHours').value) || 0;
      const sessions   = parseInt(document.getElementById('splitSessions').value) || 1;
      const baseName   = document.getElementById('splitBaseName').value || 'Work Session';
      const preview    = document.getElementById('autoSplitPreview');

      if (totalHours === 0) { preview.innerHTML = ''; return; }

      const hoursPerSession = totalHours / sessions;
      let html = '<div class="workflow-preview"><h4>Preview:</h4>';

      for (let i = 1; i <= sessions; i++) {
        const hours = Math.round(hoursPerSession * 4) / 4;
        html += `
          <div class="milestone-row">
            <div class="milestone-order">${i}</div>
            <div class="milestone-name">${escapeHtml(baseName)} ${i}</div>
            <div class="milestone-hours">${hours}h</div>
          </div>
        `;
      }
      html += '</div>';
      preview.innerHTML = html;
    }

    function applyAutoSplit() {
      const totalHours = parseFloat(document.getElementById('splitTotalHours').value) || 0;
      const sessions   = parseInt(document.getElementById('splitSessions').value) || 1;
      const baseName   = document.getElementById('splitBaseName').value || 'Work Session';
      if (totalHours === 0) return;

      const hoursPerSession = totalHours / sessions;
      currentMilestones = [];
      for (let i = 1; i <= sessions; i++) {
        const hours = Math.round(hoursPerSession * 4) / 4;
        currentMilestones.push({
          id: null,
          name: `${baseName} ${i}`,
          estimatedHours: hours,
          actualHours: 0,
          order: i,
          status: i === 1 ? 'Ready' : 'Not Started'
        });
      }
      refreshMilestoneList();
      switchMilestoneTab('individual');
      markChanged();
    }

    function markChanged() {
      hasUnsavedChanges = true;
      updateSaveButton();
      
      // Update project ID from input
      const projectIdInput = document.getElementById('projectIdInput');
      if (projectIdInput && currentProject) {
        currentProject.projectId = projectIdInput.value;
      }
    }

    function updateSaveButton() {
      const saveBtn = document.getElementById('saveBtn');
      if (!saveBtn) return;
      saveBtn.disabled = !hasUnsavedChanges;
      saveBtn.textContent = hasUnsavedChanges ? 'Save Changes *' : 'Saved';
    }

    async function saveProject() {
      if (!currentProject) return;

      try {
        document.getElementById('saveBtn').textContent = 'Saving...';

        const projectData = {
          name: document.getElementById('projectName').value,
          projectId: document.getElementById('projectIdInput').value,
          status: document.getElementById('projectStatus').value,
          instrumentMake: document.getElementById('instrumentMake').value,
          instrumentModel: document.getElementById('instrumentModel').value,
          complexity: parseInt(document.getElementById('complexity').value),
          profitability: parseInt(document.getElementById('profitability').value),
          dueDate: document.getElementById('dueDate').value || null,
          store: document.getElementById('store').value,
          intakeNotes: document.getElementById('intakeNotes').value,
          notes: document.getElementById('notes').value,
          
          // Billing data
          total: parseFloat(document.getElementById('total').value) || null,
          commission: parseFloat(document.getElementById('commission').value) || null,
          
          // Measurement data
          neckReliefBefore: parseFloat(document.getElementById('neckReliefBefore').value) || null,
          before1stString1stFret: parseFloat(document.getElementById('before1stString1stFret').value) || null,
          before1stString12thFret: parseFloat(document.getElementById('before1stString12thFret').value) || null,
          before6thString1stFret: parseFloat(document.getElementById('before6thString1stFret').value) || null,
          before6thString12thFret: parseFloat(document.getElementById('before6thString12thFret').value) || null,
          neckReliefAfter: parseFloat(document.getElementById('neckReliefAfter').value) || null,
          after1stString1stFret: parseFloat(document.getElementById('after1stString1stFret').value) || null,
          after1stString12thFret: parseFloat(document.getElementById('after1stString12thFret').value) || null,
          after6thString1stFret: parseFloat(document.getElementById('after6thString1stFret').value) || null,
          after6thString12thFret: parseFloat(document.getElementById('after6thString12thFret').value) || null,
          
          // Instrument details
          instrumentFinish: document.getElementById('instrumentFinish').value,
          serialNumber: document.getElementById('serialNumber').value,
          instrumentType: document.getElementById('instrumentType').value,
          stringBrand: document.getElementById('stringBrand').value,
          stringGauge: document.getElementById('stringGauge').value,
          tuning: document.getElementById('tuning').value,
          tremolo: document.getElementById('tremolo').value,
          fretboardRadius: parseFloat(document.getElementById('fretboardRadius').value) || null,
          fretwire: document.getElementById('fretwire').value,
          
          // Actions
          actions: {
            adjustedHeightRadius: document.getElementById('adjustedHeightRadius').checked,
            adjustedIntonation: document.getElementById('adjustedIntonation').checked,
            adjustedPickupHeight: document.getElementById('adjustedPickupHeight').checked,
            adjustedTrussRod: document.getElementById('adjustedTrussRod').checked,
            adjustedStringSlots: document.getElementById('adjustedStringSlots').checked,
            cleanedPolished: document.getElementById('cleanedPolished').checked,
            installedStretchedStrings: document.getElementById('installedStretchedStrings').checked,
            lubricatedStringSlots: document.getElementById('lubricatedStringSlots').checked,
            oiledFretboard: document.getElementById('oiledFretboard').checked,
            polishedFrets: document.getElementById('polishedFrets').checked,
            testedElectronics: document.getElementById('testedElectronics').checked,
            tightenedHardware: document.getElementById('tightenedHardware').checked,
            adjustedTremoloTension: document.getElementById('adjustedTremoloTension').checked,
            adjustedNeckAngle: document.getElementById('adjustedNeckAngle').checked
          },
          additionalActions: document.getElementById('additionalActions').value
        };

        let projectResult;

        if (isNewProject) {
          const createResponse = await fetch(`${API_URL}?action=create-project`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(projectData)
          });
          if (!createResponse.ok) {
            const errorText = await createResponse.text();
            throw new Error(`Failed to create project: ${errorText}`);
          }
          projectResult = await createResponse.json();
          if (projectResult.success && projectResult.project) {
            currentProject.id = projectResult.project.id;
            isNewProject = false;
            allProjects.push(projectResult.project);
            showMessage('Project created successfully', 'success');
          } else {
            throw new Error('Failed to create project: Invalid response');
          }
        } else {
          projectData.projectId = currentProject.id;
          const updateResponse = await fetch(`${API_URL}?action=update-project`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(projectData)
          });
          if (!updateResponse.ok) {
            const errorText = await updateResponse.text();
            throw new Error(`Failed to update project: ${errorText}`);
          }
          projectResult = await updateResponse.json();
          showMessage('Project updated successfully', 'success');
        }

        if (currentMilestones.length > 0) {
          const milestoneResponse = await fetch(`${API_URL}?action=save-milestones`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              projectId: currentProject.id,
              milestones: currentMilestones
            })
          });
          if (!milestoneResponse.ok) {
            const errorText = await milestoneResponse.text();
            throw new Error(`Failed to save milestones: ${errorText}`);
          }
          await milestoneResponse.json();
        }

        hasUnsavedChanges = false;
        updateSaveButton();

        document.getElementById('saveBtn').innerHTML = 'Saved ✓ <span class="save-indicator">Changes saved</span>';
        setTimeout(() => updateSaveButton(), 2000);

        document.getElementById('editorTitle').textContent = projectData.name;
        await refreshProjects();

      } catch (error) {
        console.error('Save failed:', error);
        showMessage('Failed to save changes: ' + error.message, 'error');
        document.getElementById('saveBtn').textContent = 'Save Changes *';
      }
    }

    function cancelChanges() {
      if (hasUnsavedChanges && !confirm('Discard unsaved changes?')) return;

      if (isNewProject) {
        currentProject = null;
        currentMilestones = [];
        isNewProject = false;

        document.getElementById('editorContent').innerHTML = `
          <div class="empty-state">
            <h3>Select a project to edit</h3>
            <p>Click on a project from the list to view and edit its details and milestones, or create a new project.</p>
          </div>
        `;
        document.getElementById('editorTitle').textContent = 'Select a project';
        document.getElementById('projectIdInput').style.display = 'none';
        displayProjectsList();
      } else if (currentProject) {
        selectProject(currentProject.id);
      }

      hasUnsavedChanges = false;
      updateSaveButton();
    }

    
  function syncEditorIntoCurrentProject() {
    if (!currentProject) return;
    // Core fields visible in the “Project Details” section
    const val = id => document.getElementById(id)?.value ?? '';

    currentProject.name = val('projectName');
    currentProject.status = val('projectStatus');
    currentProject.instrumentMake = val('instrumentMake');
    currentProject.instrumentModel = val('instrumentModel');
    currentProject.complexity = parseInt(val('complexity') || currentProject.complexity || 3, 10);
    currentProject.profitability = parseInt(val('profitability') || currentProject.profitability || 3, 10);
    currentProject.dueDate = val('dueDate') || null;
    currentProject.store = val('store') || '';
    currentProject.intakeNotes = val('intakeNotes') || '';

    // Billing (if shown)
    const totalEl = document.getElementById('total');
    const commissionEl = document.getElementById('commission');
    if (totalEl) currentProject.total = totalEl.value ? parseFloat(totalEl.value) : null;
    if (commissionEl) currentProject.commission = commissionEl.value ? parseFloat(commissionEl.value) : null;

    // Measurements (only if section expanded—safe to read anyway)
    const num = id => {
      const v = document.getElementById(id)?.value;
      return (v === '' || v == null) ? null : parseFloat(v);
    };

    currentProject.neckReliefBefore = num('neckReliefBefore');
    currentProject.before1stString1stFret = num('before1stString1stFret');
    currentProject.before1stString12thFret = num('before1stString12thFret');
    currentProject.before6thString1stFret = num('before6thString1stFret');
    currentProject.before6thString12thFret = num('before6thString12thFret');

    currentProject.neckReliefAfter = num('neckReliefAfter');
    currentProject.after1stString1stFret = num('after1stString1stFret');
    currentProject.after1stString12thFret = num('after1stString12thFret');
    currentProject.after6thString1stFret = num('after6thString1stFret');
    currentProject.after6thString12thFret = num('after6thString12thFret');

    // Instrument details
    currentProject.instrumentFinish = val('instrumentFinish');
    currentProject.serialNumber = val('serialNumber');
    currentProject.instrumentType = val('instrumentType');
    currentProject.stringBrand = val('stringBrand');
    currentProject.stringGauge = val('stringGauge');
    currentProject.tuning = val('tuning');
    currentProject.tremolo = val('tremolo');
    currentProject.fretboardRadius = (() => {
      const r = val('fretboardRadius');
      return r ? parseFloat(r) : null;
    })();
    currentProject.fretwire = val('fretwire');

    // Actions (add this to syncEditorIntoCurrentProject function)
if (!currentProject.actions) currentProject.actions = {};

currentProject.actions.adjustedHeightRadius = document.getElementById('adjustedHeightRadius')?.checked || false;
currentProject.actions.adjustedIntonation = document.getElementById('adjustedIntonation')?.checked || false;
currentProject.actions.adjustedPickupHeight = document.getElementById('adjustedPickupHeight')?.checked || false;
currentProject.actions.adjustedTrussRod = document.getElementById('adjustedTrussRod')?.checked || false;
currentProject.actions.adjustedStringSlots = document.getElementById('adjustedStringSlots')?.checked || false;
currentProject.actions.cleanedPolished = document.getElementById('cleanedPolished')?.checked || false;
currentProject.actions.installedStretchedStrings = document.getElementById('installedStretchedStrings')?.checked || false;
currentProject.actions.lubricatedStringSlots = document.getElementById('lubricatedStringSlots')?.checked || false;
currentProject.actions.oiledFretboard = document.getElementById('oiledFretboard')?.checked || false;
currentProject.actions.polishedFrets = document.getElementById('polishedFrets')?.checked || false;
currentProject.actions.testedElectronics = document.getElementById('testedElectronics')?.checked || false;
currentProject.actions.tightenedHardware = document.getElementById('tightenedHardware')?.checked || false;
currentProject.actions.adjustedTremoloTension = document.getElementById('adjustedTremoloTension')?.checked || false;
currentProject.actions.adjustedNeckAngle = document.getElementById('adjustedNeckAngle')?.checked || false;

currentProject.additionalActions = document.getElementById('additionalActions')?.value || '';

    // Actions (“Standard Actions”) are already mapped in your API to currentProject.actions
    // If you later add action checkboxes in the editor UI, read them here and update currentProject.actions accordingly.
  }

  function openReportForCurrent() {
    if (!currentProject) {
      showMessage('Select a project first', 'error');
      return;
    }
    // Pull any on-screen edits into the object:
    syncEditorIntoCurrentProject();

    // Attach milestones currently loaded for this project:
    const payload = {
      project: currentProject,
      milestones: currentMilestones || []
    };

    // Save to localStorage and pop new window with the printable report:
    localStorage.setItem('luthierReportData', JSON.stringify(payload));
    window.open('luthier_report_template.html', '_blank', 'noopener');
  }

  </script>
</body>
</html>
